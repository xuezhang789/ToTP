{% extends 'base.html' %}
{% block title %}æ³¨å†Œ - TOTPç®¡ç†å¹³å°{% endblock %}
{% block head %}
<meta name="google-signin-client_id" content="{{ GOOGLE_CLIENT_ID }}">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
    .password-strength-bar { height: 6px; border-radius: 999px; }
    .password-assistant button { white-space: nowrap; }
    .password-tips li { position: relative; padding-left: 1.25rem; }
    .password-tips li::before {
        content: "\2713";
        position: absolute;
        left: 0;
        top: 0;
        color: var(--bs-success);
    }
    .password-tips li.is-warning::before {
        content: "\26A0";
        color: var(--bs-warning);
    }
    .password-tips li.is-error::before {
        content: "\2717";
        color: var(--bs-danger);
    }
</style>
{% endblock %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-md-6 col-lg-5">
        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body p-4">
                <div class="text-center mb-3">
                    <i class="bi bi-person-plus-fill text-primary fs-1"></i>
                </div>
                <h1 class="h4 mb-2 text-center">åˆ›å»ºä½ çš„è´¦æˆ·</h1>
                <p class="text-center text-muted small mb-4">æ¬¢è¿åŠ å…¥ TOTP ç®¡ç†å¹³å°ï¼Œå‡ æ­¥å³å¯å¼€å¯æ›´å®‰å…¨çš„åŒé‡éªŒè¯ä½“éªŒã€‚</p>
                <form method="post" action="{% url 'accounts:signup' %}">{% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label" for="signup-username">ç”¨æˆ·å</label>
                        <input id="signup-username" class="form-control" name="username" placeholder="ä¾‹å¦‚ï¼štotp_fan"
                               value="{{ username_value|default:'' }}" autocomplete="username" required>
                        <div class="form-text">ç”¨äºç™»å½•å’Œå±•ç¤ºç»™å›¢é˜Ÿæˆå‘˜ï¼Œå¯éšæ—¶åœ¨ä¸ªäººè®¾ç½®ä¸­ä¿®æ”¹ã€‚</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="signup-email">é‚®ç®±ï¼ˆå¯é€‰ï¼‰</label>
                        <input id="signup-email" type="email" class="form-control" name="email" placeholder="ä¾¿äºæ‰¾å›è´¦å·çš„é‚®ç®±"
                               value="{{ email_value|default:'' }}" autocomplete="email">
                        <div class="form-text">æ¨èå¡«å†™å¸¸ç”¨é‚®ç®±ï¼Œå¿˜è®°å¯†ç æ—¶å¯ä»¥å¿«é€Ÿæ‰¾å›ã€‚</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="signup-password">å¯†ç </label>
                        <div class="input-group">
                            <input id="signup-password" type="password" class="form-control" name="password"
                                   placeholder="å¯†ç " autocomplete="new-password" required>
                            <button class="btn btn-outline-secondary" type="button" id="password-toggle" aria-label="æ˜¾ç¤ºæˆ–éšè—å¯†ç ">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div class="password-assistant mt-2">
                            <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
                                <div class="form-text mb-0" id="passwordHint">ä¸ºä¿éšœè´¦æˆ·å®‰å…¨ï¼Œè¯·ä½¿ç”¨è‡³å°‘ 8 ä¸ªå­—ç¬¦ï¼Œå¹¶æ··åˆå¤šç§å­—ç¬¦ç±»å‹ã€‚</div>
                                <button class="btn btn-sm btn-outline-primary" type="button" id="password-generate-btn">ç”Ÿæˆå¼ºå¯†ç </button>
                            </div>
                            <div class="progress password-strength-bar mt-2">
                                <div class="progress-bar bg-secondary" id="password-strength-fill" style="width: 0%"></div>
                            </div>
                            <div class="form-text mt-2" id="password-strength-label">ç­‰å¾…è¾“å…¥å¯†ç ...</div>
                            <ul class="password-tips list-unstyled small text-muted mt-2" id="password-suggestions"></ul>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100" type="submit">ç«‹å³åˆ›å»ºå¹¶ç™»å½•</button>
                </form>
                <div class="text-center text-muted small my-3">æˆ–</div>

                <!-- Google One Tap + Sign Up button -->
                <div id="g_id_onload"
                     data-client_id="{{ GOOGLE_CLIENT_ID }}"
                     data-context="signup"
                     data-ux_mode="popup"
                     data-callback="handleCredentialResponse"
                     data-auto_prompt="true">
                </div>
                <div class="g_id_signin" data-type="standard" data-shape="rect" data-theme="outline"
                     data-text="signup_with" data-size="large" data-logo_alignment="left"></div>
                <div class="text-center mt-3 small">å·²æœ‰è´¦å·ï¼Ÿ<a href="{% url 'accounts:login' %}">å»ç™»å½•</a></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    (function(){
      const passwordInput = document.getElementById('signup-password');
      if(!passwordInput) return;

      const usernameInput = document.getElementById('signup-username');
      const strengthFill = document.getElementById('password-strength-fill');
      const strengthLabel = document.getElementById('password-strength-label');
      const suggestionsEl = document.getElementById('password-suggestions');
      const generateBtn = document.getElementById('password-generate-btn');
      const toggleBtn = document.getElementById('password-toggle');

      const WEAK_PASSWORDS = new Set([
        'password','123456','123456789','qwerty','abc123','password1','111111','12345678','123123','qwertyuiop',
        'letmein','admin','welcome','iloveyou','dragon','monkey','login','000000','1q2w3e4r','zaq12wsx'
      ]);

      function classifyStrength(score){
        if(score <= 1) return {variant: 'danger', label: 'å¯†ç å¤ªå¼±ï¼Œè¯·ç»§ç»­åŠ å¼º'};
        if(score === 2) return {variant: 'warning', label: 'å®‰å…¨æ€§ä¸€èˆ¬ï¼Œå†æå‡ä¸€ä¸‹æ›´å®‰å¿ƒ'};
        if(score === 3) return {variant: 'info', label: 'ä¸é”™çš„å¯†ç ï¼Œå†è¡¥å……1~2ä¸ªå­—ç¬¦æ›´ä½³'};
        return {variant: 'success', label: 'å®‰å…¨æ€§å¾ˆé«˜ï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨'};
      }

      function evaluatePassword(pwd, username){
        const suggestions = [];
        if(!pwd){
          return {score: 0, label: 'ç­‰å¾…è¾“å…¥å¯†ç ...', variant: 'secondary', suggestions: ['è¾“å…¥å¯†ç åå³å¯æŸ¥çœ‹å¼ºåº¦å»ºè®®ã€‚']};
        }

        const lengthScore = Math.min(4, Math.floor(pwd.length / 3));
        let score = lengthScore;

        const varietyChecks = [/[a-z]/, /[A-Z]/, /\d/, /[^A-Za-z0-9]/];
        const varietyCount = varietyChecks.reduce((acc, re) => acc + (re.test(pwd) ? 1 : 0), 0);
        score += varietyCount - 1;

        if(varietyCount < 3){
          suggestions.push('å†åŠ å…¥å¤§å†™ã€å°å†™ã€æ•°å­—æˆ–ç¬¦å·ä¸­çš„ç¼ºå¤±ç±»å‹ã€‚');
        }

        if(/(.)\1{2,}/.test(pwd)){
          score -= 1;
          suggestions.push('é¿å…è¿ç»­é‡å¤çš„å­—ç¬¦ï¼Œæ¯”å¦‚ "aaa"ã€‚');
        }

        if(/(?=012|123|234|345|456|567|678|789)/.test(pwd)){
          score -= 1;
          suggestions.push('å°è¯•æ‰“ä¹±é€’å¢çš„æ•°å­—é¡ºåºã€‚');
        }

        if(/(?=abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz)/i.test(pwd)){
          score -= 1;
          suggestions.push('æ‰“ç ´é”®ç›˜ä¸Šçš„é¡ºåºå­—ç¬¦ç»„åˆã€‚');
        }

        if(username && pwd.toLowerCase().includes(username.toLowerCase())){
          score -= 1;
          suggestions.push('ä¸è¦æŠŠç”¨æˆ·åæˆ–è´¦å·ä¿¡æ¯æ”¾å…¥å¯†ç ä¸­ã€‚');
        }

        if(WEAK_PASSWORDS.has(pwd.toLowerCase())){
          score = Math.min(score, 1);
          suggestions.unshift('è¿™ä¸ªå¯†ç è¿‡äºå¸¸è§ï¼Œæ¢ä¸€ä¸ªç‹¬ç‰¹çš„å§ã€‚');
        }

        score = Math.max(0, Math.min(4, score));

        const classification = classifyStrength(score);

        if(!suggestions.length && score >= 3){
          suggestions.push('ğŸ‘ å¯†ç çœ‹èµ·æ¥å¾ˆå¯é ï¼Œè¯·å¦¥å–„ä¿ç®¡å¹¶å®šæœŸæ›´æ–°ã€‚');
        }
        return {
          score,
          label: classification.label,
          variant: classification.variant,
          suggestions,
        };
      }

      function renderSuggestions(items){
        suggestionsEl.innerHTML = '';
        if(!items || !items.length) return;
        items.forEach((text) => {
          const li = document.createElement('li');
          li.textContent = text;
          li.className = '';
          if(/æ¢ä¸€ä¸ª|é¿å…|ä¸è¦|æ‰“ç ´/.test(text)){
            li.classList.add('is-warning');
          }
          if(/è¿‡äºå¸¸è§|å¼±|è¯·ç»§ç»­/.test(text)){
            li.classList.add('is-error');
          }
          suggestionsEl.appendChild(li);
        });
      }

      function updateStrength(){
        const pwd = passwordInput.value;
        const username = usernameInput ? usernameInput.value.trim() : '';
        const result = evaluatePassword(pwd, username);
        const basePct = (result.score / 4) * 100;
        const pct = pwd ? Math.max(10, basePct) : 0;
        strengthFill.style.width = `${pct}%`;
        strengthFill.className = `progress-bar bg-${result.variant}`;
        strengthLabel.textContent = result.label;
        renderSuggestions(result.suggestions);
      }

      function generatePassword(){
        const charset = {
          upper: 'ABCDEFGHJKLMNPQRSTUVWXYZ',
          lower: 'abcdefghijkmnopqrstuvwxyz',
          digits: '23456789',
          symbols: '@#$%&_+-=~',
        };
        const all = Object.values(charset).join('');
        const parts = [
          randomFrom(charset.upper),
          randomFrom(charset.lower),
          randomFrom(charset.digits),
          randomFrom(charset.symbols),
        ];
        const targetLength = 14 + Math.floor(Math.random() * 5);
        while(parts.join('').length < targetLength){
          parts.push(randomFrom(all));
        }
        const password = shuffle(parts).join('');
        passwordInput.value = password;
        passwordInput.dispatchEvent(new Event('input'));
        passwordInput.focus();
        passwordInput.select();
      }

      function randomFrom(str){
        if(window.crypto && window.crypto.getRandomValues){
          const array = new Uint32Array(1);
          window.crypto.getRandomValues(array);
          return str[array[0] % str.length];
        }
        return str[Math.floor(Math.random() * str.length)];
      }

      function shuffle(arr){
        for(let i = arr.length - 1; i > 0; i -= 1){
          let j;
          if(window.crypto && window.crypto.getRandomValues){
            const array = new Uint32Array(1);
            window.crypto.getRandomValues(array);
            j = array[0] % (i + 1);
          }else{
            j = Math.floor(Math.random() * (i + 1));
          }
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      if(generateBtn){
        generateBtn.addEventListener('click', generatePassword);
      }

      if(toggleBtn){
        toggleBtn.addEventListener('click', () => {
          const isHidden = passwordInput.getAttribute('type') === 'password';
          passwordInput.setAttribute('type', isHidden ? 'text' : 'password');
          toggleBtn.innerHTML = isHidden ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
        });
      }

      if(passwordInput){
        passwordInput.addEventListener('input', updateStrength);
        passwordInput.addEventListener('blur', updateStrength);
      }

      if(usernameInput){
        usernameInput.addEventListener('blur', updateStrength);
      }

      updateStrength();
    })();

    async function onetapLogin(credential){
      const r = await fetch("{% url 'accounts:google_onetap' %}", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({credential})
      });
      if(r.ok){
        window.location.href = "{{ request.GET.next|default:'/' }}";
      }else{
        const t = await r.text();
        console.error("Google One Tap failed:", t);
        alert("Google ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–ä½¿ç”¨è´¦å·å¯†ç ç™»å½•ã€‚");
      }
    }
    function handleCredentialResponse(resp){ onetapLogin(resp.credential); }
</script>
{% endblock %}
