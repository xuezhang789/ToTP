{% extends "base.html" %}
{% block title %}ä¸ªäººèµ„æ–™{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-lg-8 col-xl-6">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <h1 class="h4 mb-0">ä¸ªäººèµ„æ–™</h1>
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'totp:list' %}">è¿”å›æˆ‘çš„å¯†é’¥</a>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">ç”¨æˆ·å</label>
                        <input type="text" class="form-control" value="{{ user_obj.username }}" disabled>
                    </div>
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <label class="form-label" for="{{ form.first_name.id_for_label }}">å</label>
                            {{ form.first_name }}
                            {% if form.first_name.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.first_name.errors|join:", " }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label" for="{{ form.last_name.id_for_label }}">å§“</label>
                            {{ form.last_name }}
                            {% if form.last_name.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.last_name.errors|join:", " }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label" for="{{ form.email.id_for_label }}">é‚®ç®±</label>
                        {{ form.email }}
                        <div class="form-text">ç”¨äºæ¥æ”¶é€šçŸ¥å’Œå®‰å…¨æé†’ï¼Œå¯ç•™ç©ºã€‚</div>
                        {% if form.email.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.email.errors|join:", " }}
                        </div>
                        {% endif %}
                    </div>

                    <div class="mt-4">
                        <button class="btn btn-primary w-100" type="submit">ä¿å­˜ä¿®æ”¹</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-body">
                <h2 class="h6 text-muted mb-3">å®‰å…¨ä¿¡æ¯</h2>
                <dl class="row mb-0">
                    <dt class="col-sm-4 text-muted">ä¸Šæ¬¡ç™»å½•</dt>
                    <dd class="col-sm-8">{{ user_obj.last_login|default:"--" }}</dd>
                    <dt class="col-sm-4 text-muted">æ³¨å†Œæ—¶é—´</dt>
                    <dd class="col-sm-8">{{ user_obj.date_joined }}</dd>
                </dl>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-body">
                <h2 class="h6 mb-3">ä¿®æ”¹å¯†ç </h2>
                <form method="post" novalidate>
                    {% csrf_token %}
                    <input type="hidden" name="password_submit" value="1">
                    {% if password_form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ password_form.non_field_errors|join:" " }}
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        <label class="form-label" for="{{ password_form.old_password.id_for_label }}">{{ password_form.old_password.label }}</label>
                        {{ password_form.old_password }}
                        {% if password_form.old_password.errors %}
                        <div class="invalid-feedback d-block">
                            {{ password_form.old_password.errors|join:", " }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="{{ password_form.new_password1.id_for_label }}">{{ password_form.new_password1.label }}</label>
                        {{ password_form.new_password1 }}
                        <div class="password-assistant mt-2">
                            <div class="form-text mb-1" id="password-change-hint">è¯·è¾“å…¥è‡³å°‘ 8 ä½ï¼Œå¹¶æ··åˆå¤šç§å­—ç¬¦ç±»å‹ä»¥æå‡å®‰å…¨æ€§ã€‚</div>
                            <div class="progress password-strength-bar">
                                <div class="progress-bar bg-secondary" id="password-change-strength-fill" style="width:0%"></div>
                            </div>
                            <div class="form-text mt-2" id="password-change-strength-label">ç­‰å¾…è¾“å…¥å¯†ç ...</div>
                            <ul class="password-tips list-unstyled small text-muted mt-2" id="password-change-suggestions"></ul>
                        </div>
                        {% if password_form.new_password1.help_text %}
                        <div class="form-text">{{ password_form.new_password1.help_text|safe }}</div>
                        {% endif %}
                        {% if password_form.new_password1.errors %}
                        <div class="invalid-feedback d-block">
                            {{ password_form.new_password1.errors|join:", " }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="mb-4">
                        <label class="form-label" for="{{ password_form.new_password2.id_for_label }}">{{ password_form.new_password2.label }}</label>
                        {{ password_form.new_password2 }}
                        {% if password_form.new_password2.errors %}
                        <div class="invalid-feedback d-block">
                            {{ password_form.new_password2.errors|join:", " }}
                        </div>
                        {% endif %}
                    </div>
                    <button class="btn btn-outline-primary w-100" type="submit">æ›´æ–°å¯†ç </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
  (function () {
    const passwordInput = document.getElementById('{{ password_form.new_password1.id_for_label }}');
    if (!passwordInput) {
      return;
    }

    const username = '{{ user_obj.username|escapejs }}';
    const strengthFill = document.getElementById('password-change-strength-fill');
    const strengthLabel = document.getElementById('password-change-strength-label');
    const suggestionsEl = document.getElementById('password-change-suggestions');

    const WEAK_PASSWORDS = new Set([
      'password', '123456', '123456789', 'qwerty', 'abc123', 'password1', '111111', '12345678', '123123', 'qwertyuiop',
      'letmein', 'admin', 'welcome', 'iloveyou', 'dragon', 'monkey', 'login', '000000', '1q2w3e4r', 'zaq12wsx'
    ]);

    function classifyStrength(score) {
      if (score <= 1) return { variant: 'danger', label: 'å¯†ç å¤ªå¼±ï¼Œè¯·ç»§ç»­åŠ å¼º' };
      if (score === 2) return { variant: 'warning', label: 'å®‰å…¨æ€§ä¸€èˆ¬ï¼Œå†æå‡ä¸€ä¸‹æ›´å®‰å¿ƒ' };
      if (score === 3) return { variant: 'info', label: 'ä¸é”™çš„å¯†ç ï¼Œå¯å†è¡¥å……1~2ä¸ªå­—ç¬¦æ›´ä½³' };
      return { variant: 'success', label: 'å®‰å…¨æ€§å¾ˆé«˜ï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨' };
    }

    function evaluatePassword(pwd, uname) {
      const suggestions = [];
      if (!pwd) {
        return {
          score: 0,
          label: 'ç­‰å¾…è¾“å…¥å¯†ç ...',
          variant: 'secondary',
          suggestions: ['è¾“å…¥å¯†ç åå³å¯æŸ¥çœ‹å¼ºåº¦å»ºè®®ã€‚'],
        };
      }

      const lengthScore = Math.min(4, Math.floor(pwd.length / 3));
      let score = lengthScore;

      const varietyChecks = [/[a-z]/, /[A-Z]/, /\d/, /[^A-Za-z0-9]/];
      const varietyCount = varietyChecks.reduce((acc, re) => acc + (re.test(pwd) ? 1 : 0), 0);
      score += varietyCount - 1;

      if (varietyCount < 3) {
        suggestions.push('å†åŠ å…¥å¤§å†™ã€å°å†™ã€æ•°å­—æˆ–ç¬¦å·ä¸­çš„ç¼ºå¤±ç±»å‹ã€‚');
      }

      if (/(.)\1{2,}/.test(pwd)) {
        score -= 1;
        suggestions.push('é¿å…è¿ç»­é‡å¤çš„å­—ç¬¦ï¼Œæ¯”å¦‚ "aaa"ã€‚');
      }

      if (/(?=012|123|234|345|456|567|678|789)/.test(pwd)) {
        score -= 1;
        suggestions.push('å°è¯•æ‰“ä¹±é€’å¢çš„æ•°å­—é¡ºåºã€‚');
      }

      if (/(?=abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz)/i.test(pwd)) {
        score -= 1;
        suggestions.push('æ‰“ç ´é”®ç›˜ä¸Šçš„é¡ºåºå­—ç¬¦ç»„åˆã€‚');
      }

      if (uname && pwd.toLowerCase().includes(uname.toLowerCase())) {
        score -= 1;
        suggestions.push('ä¸è¦æŠŠç”¨æˆ·åæˆ–è´¦å·ä¿¡æ¯æ”¾å…¥å¯†ç ä¸­ã€‚');
      }

      if (WEAK_PASSWORDS.has(pwd.toLowerCase())) {
        score = Math.min(score, 1);
        suggestions.unshift('è¿™ä¸ªå¯†ç è¿‡äºå¸¸è§ï¼Œæ¢ä¸€ä¸ªç‹¬ç‰¹çš„å§ã€‚');
      }

      score = Math.max(0, Math.min(4, score));
      const classification = classifyStrength(score);

      if (!suggestions.length && score >= 3) {
        suggestions.push('ğŸ‘ å¯†ç çœ‹èµ·æ¥å¾ˆå¯é ï¼Œè¯·å¦¥å–„ä¿ç®¡å¹¶å®šæœŸæ›´æ–°ã€‚');
      }

      return {
        score,
        label: classification.label,
        variant: classification.variant,
        suggestions,
      };
    }

    function renderSuggestions(items) {
      suggestionsEl.innerHTML = '';
      if (!items || !items.length) {
        return;
      }
      items.forEach((text) => {
        const li = document.createElement('li');
        li.textContent = text;
        if (/è¿‡äºå¸¸è§|å¼±|é¿å…|ä¸è¦|æ‰“ç ´/.test(text)) {
          li.classList.add('is-warning');
        }
        suggestionsEl.appendChild(li);
      });
    }

    function updateStrength() {
      const pwd = passwordInput.value;
      const result = evaluatePassword(pwd, username);
      const basePct = (result.score / 4) * 100;
      const pct = pwd ? Math.max(10, basePct) : 0;
      strengthFill.style.width = `${pct}%`;
      strengthFill.className = `progress-bar bg-${result.variant}`;
      strengthLabel.textContent = result.label;
      renderSuggestions(result.suggestions);
    }

    passwordInput.addEventListener('input', updateStrength);
    updateStrength();
  })();
</script>
{% endblock %}
