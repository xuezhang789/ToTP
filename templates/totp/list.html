{% extends 'base.html' %}
{% block title %}我的密钥{% endblock %}
{% block content %}
<style>
    .search-group { white-space: nowrap; }
    .search-input { width: min(100%, 420px); }
    .search-group .btn { white-space: nowrap; }
    @media (max-width: 576px){ .search-input { width: 100%; } }
</style>

<div class="mb-3">
    <div class="row g-2 align-items-center">
        <div class="col-12 col-md-auto order-1">
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal" type="button">
                    添加密钥
                </button>
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importModal"
                        type="button">批量导入
                </button>
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addGroupModal"
                        type="button">添加分组
                </button>
            </div>
        </div>
        <div class="col-12 col-md order-2 order-md-2">
            <form id="searchForm" class="d-flex justify-content-md-end" method="get" role="search"
                  aria-label="按名称搜索">
                <div class="input-group flex-nowrap w-100 w-md-auto search-group ms-md-auto">
                    <select id="group" name="group" class="form-select">
                        <option value="">全部分组</option>
                        <option value="0" {% if group_id == '0' %}selected{% endif %}>未分组</option>
                        {% for g in groups %}
                        <option value="{{ g.id }}" {% if group_id|default:'' == g.id|stringformat:'s' %}selected{% endif %}>{{ g.name }}</option>
                        {% endfor %}
                    </select>
                    <span class="input-group-text bg-transparent">
                        <svg width="18" height="18" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7" stroke="currentColor" fill="none" stroke-width="2"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                    </span>
                    <input id="q" name="q" value="{{ q|default_if_none:'' }}" class="form-control search-input"
                           type="search" placeholder="仅按名称搜索" autocomplete="off" enterkeyhint="search"
                           spellcheck="false" maxlength="64">
                    <button class="btn btn-outline-secondary d-none" id="clearBtn" type="button" aria-label="清空搜索">
                        清空
                    </button>
                    <button class="btn btn-primary" type="submit" id="searchBtn"><span
                            class="spinner-border spinner-border-sm me-1 d-none" id="searchSpinner" role="status"
                            aria-hidden="true"></span>搜索
                    </button>
                    {% if q or group_id %}<a class="btn btn-outline-secondary" href="{% url 'totp:list' %}">重置</a>{% endif %}
                </div>
            </form>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <strong>我的密钥</strong>
        <div>下次刷新倒计时：<span id="countdown">--</span>s</div>
    </div>
    <div class="table-responsive">
        <table class="table table-hover table-striped mb-0 align-middle" id="totpTable">
            <thead>
            <tr>
                <th>名称</th>
                <th>分组</th>
                <th class="text-nowrap">验证码</th>
                <th class="text-nowrap">有效期</th>
                <th class="text-nowrap">操作</th>
            </tr>
            </thead>
            <tbody id="tbody">
            {% for e in entries %}
            {% include 'totp/_entry_row.html' with e=e %}
            {% empty %}
            <tr class="no-data">
                <td colspan="5" class="text-center text-muted py-5">暂无数据</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% if page_obj.has_other_pages %}
    <div class="card-footer">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-0">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link"
                       href="?{% if q %}q={{ q|urlencode }}&amp;{% endif %}{% if group_id %}group={{ group_id }}&amp;{% endif %}page={{ page_obj.previous_page_number }}"
                       aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                {% if num == page_obj.number %}
                <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
                {% else %}
                <li class="page-item"><a class="page-link"
                                         href="?{% if q %}q={{ q|urlencode }}&amp;{% endif %}{% if group_id %}group={{ group_id }}&amp;{% endif %}page={{ num }}">{{ num }}</a></li>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link"
                       href="?{% if q %}q={{ q|urlencode }}&amp;{% endif %}{% if group_id %}group={{ group_id }}&amp;{% endif %}page={{ page_obj.next_page_number }}"
                       aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}

</div>

{% include 'totp/add_modal.html' %}
{% include 'totp/import_modal.html' %}
{% include 'totp/add_group_modal.html' %}
{% endblock %}

{% block scripts %}
<script>
    const tbody = document.getElementById('tbody');
    const countdownEl = document.getElementById('countdown');
    let timer = null;

    async function refreshTokens(){
      try{
        const resp = await fetch('{% url "totp:api_tokens" %}', {headers: {'X-Requested-With':'fetch'}});
        const data = await resp.json();
        const remaining = data.remaining ?? 30;
        countdownEl.textContent = remaining;
        const codes = new Map(data.items.map(i => [i.id, i]));
        tbody.querySelectorAll('tr[data-id]').forEach(tr => {
          const id = parseInt(tr.dataset.id);
          const item = codes.get(id);
          if(!item) return;
          tr.querySelector('.code-text').textContent = item.code;
          tr.querySelector('.copy-btn').dataset.code = item.code;
          const period = item.period || 30;
          const percent = Math.round(((period-remaining)/period)*100);
          tr.querySelector('.progress-bar').style.width = Math.max(0, Math.min(100, percent)) + '%';
          tr.querySelector('.remain').textContent = remaining + 's';
        });
      }catch(e){ console.error(e); }
    }

    function startTicker(){
      clearInterval(timer);
      timer = setInterval(async ()=>{
        const now = parseInt(countdownEl.textContent)||30;
        if(now<=1){ await refreshTokens(); }
        else { countdownEl.textContent = now - 1; }
        tbody.querySelectorAll('tr[data-id]').forEach(tr => {
          const remain = parseInt(tr.querySelector('.remain').textContent)||30;
          const period = 30;
          const next = Math.max(0, remain-1);
          const percent = Math.round(((period-next)/period)*100);
          tr.querySelector('.remain').textContent = next + 's';
          tr.querySelector('.progress-bar').style.width = Math.max(0, Math.min(100, percent)) + '%';
        });
      }, 1000);
    }
    refreshTokens().then(startTicker);

    tbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('.copy-btn');
      if(!btn) return;
      navigator.clipboard.writeText(btn.dataset.code).then(()=>{
        const oldHTML = btn.innerHTML;
        btn.innerHTML = '已复制';
        setTimeout(() => { btn.innerHTML = oldHTML; }, 1000);
      });
    });

    // 搜索交互
    const form = document.getElementById('searchForm');
    const qInput = document.getElementById('q');
       const groupSelect = document.getElementById('group');
    const clearBtn = document.getElementById('clearBtn');
    const searchBtn = document.getElementById('searchBtn');
    const spinner = document.getElementById('searchSpinner');
    function updateClear(){ clearBtn.classList.toggle('d-none', !qInput.value.trim() && !groupSelect.value); }
    updateClear();
    qInput.addEventListener('input', updateClear);
    groupSelect.addEventListener('change', updateClear);
    clearBtn.addEventListener('click', ()=>{ qInput.value=''; groupSelect.value=''; updateClear(); window.location.href='{% url "totp:list" %}'; });
    form.addEventListener('submit', ()=>{ qInput.value=qInput.value.trim(); searchBtn.disabled=true; spinner.classList.remove('d-none'); });
</script>
<script>
    (function() {
      // 读取 URL 参数 modal=add / modal=import
      const params = new URLSearchParams(window.location.search);
      const modal = params.get('modal');

      if (!modal) return;

      const showModal = (id) => {
        const el = document.getElementById(id);
        if (!el) return;
        const m = new bootstrap.Modal(el);
        m.show();
      };

      if (modal === 'add') {
        showModal('addModal');      // 请确保你的“添加密钥”模态框 id="addModal"
      } else if (modal === 'import') {
        showModal('importModal');   // 请确保你的“批量导入”模态框 id="importModal"
      }
    })();
</script>
{% endblock %}
