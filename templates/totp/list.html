{% extends 'base.html' %}
{% block title %}我的密钥-TOTP管理平台{% endblock %}
{% block head %}
{{ block.super }}
<style>
    .search-group { white-space: nowrap; }
    .search-input { width: min(100%, 420px); }
    .search-group .btn { white-space: nowrap; }
    @media (max-width: 576px) {
        .search-input { width: 100%; }
    }
</style>
{% endblock %}

{% block content %}

<div class="mb-3">
    <div class="row g-2 align-items-center">
        <div class="col-12 col-md-auto order-1">
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal" type="button">
                    添加密钥
                </button>
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importModal"
                        type="button">批量导入
                </button>
                <a class="btn btn-outline-secondary" href="{% url 'totp:export' %}" id="exportPlainBtn">
                    导出密钥
                </a>
                <a class="btn btn-outline-success" href="{% url 'totp:export_offline' %}" id="exportOfflineBtn">
                    离线导出
                </a>
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addGroupModal"
                        type="button">添加分组
                </button>
                <a class="btn btn-outline-danger" href="{% url 'totp:trash' %}">回收站</a>
            </div>
        </div>
        <div class="col-12 col-md order-2 order-md-2">
            <form id="searchForm" class="d-flex justify-content-md-end" method="get" role="search"
                  aria-label="按名称搜索">
                <div class="input-group flex-nowrap w-100 w-md-auto search-group ms-md-auto">
                    <select id="group" name="group" class="form-select">
                        <option value="">全部分组</option>
                        <option value="0" {% if group_id == '0' %}selected{% endif %}>未分组</option>
                        {% for g in groups %}
                        <option value="{{ g.id }}" {% if group_id|default:'' == g.id|stringformat:'s' %}selected{% endif %}>{{ g.name }}</option>
                        {% endfor %}
                    </select>
                    <span class="input-group-text bg-transparent">
                        <svg width="18" height="18" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7" stroke="currentColor" fill="none" stroke-width="2"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                    </span>
                    <input id="q" name="q" value="{{ q|default_if_none:'' }}" class="form-control search-input"
                           type="search" placeholder="仅按名称搜索" autocomplete="off" enterkeyhint="search"
                           spellcheck="false" maxlength="64">
                    <button class="btn btn-outline-secondary d-none" id="clearBtn" type="button" aria-label="清空搜索">
                        清空
                    </button>
                    <button class="btn btn-primary" type="submit" id="searchBtn"><span
                            class="spinner-border spinner-border-sm me-1 d-none" id="searchSpinner" role="status"
                            aria-hidden="true"></span>搜索
                    </button>
                    {% if q or group_id %}<a class="btn btn-outline-secondary" href="{% url 'totp:list' %}">重置</a>{% endif %}
                </div>
            </form>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <strong>我的密钥</strong>
        <div>下次刷新倒计时：<span id="countdown">--</span>s</div>
    </div>
    <div class="table-responsive">
        <table class="table table-hover table-striped mb-0 align-middle" id="totpTable">
            <thead>
            <tr>
                <th>名称</th>
                <th>分组</th>
                <th class="text-nowrap">验证码</th>
                <th class="text-nowrap">有效期</th>
                <th class="text-nowrap">操作</th>
            </tr>
            </thead>
            <tbody id="tbody">
            {% for e in entries %}
            {% include 'totp/_entry_row.html' with e=e groups=groups %}
            {% empty %}
            <tr class="no-data">
                <td colspan="5" class="text-center text-muted py-5">暂无数据</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% if page_obj.has_other_pages %}
    <div class="card-footer">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-0">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link"
                       href="?{% if q %}q={{ q|urlencode }}&amp;{% endif %}{% if group_id %}group={{ group_id }}&amp;{% endif %}page={{ page_obj.previous_page_number }}"
                       aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                {% if num == page_obj.number %}
                <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
                {% else %}
                <li class="page-item"><a class="page-link"
                                         href="?{% if q %}q={{ q|urlencode }}&amp;{% endif %}{% if group_id %}group={{ group_id }}&amp;{% endif %}page={{ num }}">{{ num }}</a></li>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link"
                       href="?{% if q %}q={{ q|urlencode }}&amp;{% endif %}{% if group_id %}group={{ group_id }}&amp;{% endif %}page={{ page_obj.next_page_number }}"
                       aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}

</div>

<div class="modal fade" id="shareLinkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">生成一次性访问链接</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <div id="shareLinkAlert" class="alert alert-danger d-none" role="alert"></div>
                <div class="mb-3">
                    <label class="form-label">当前密钥</label>
                    <div class="form-control-plaintext fw-semibold" id="shareLinkEntryLabel">--</div>
                </div>
                <form id="shareLinkForm" class="needs-validation" novalidate>
                    <input type="hidden" name="entry_id" id="shareLinkEntryId">
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <label class="form-label" for="shareLinkDuration">有效期</label>
                            <select class="form-select" id="shareLinkDuration" name="duration">
                                <option value="5">5 分钟</option>
                                <option value="10" selected>10 分钟</option>
                                <option value="30">30 分钟</option>
                                <option value="60">60 分钟</option>
                            </select>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label" for="shareLinkMaxViews">可查看次数</label>
                            <select class="form-select" id="shareLinkMaxViews" name="max_views">
                                <option value="1">1 次</option>
                                <option value="2">2 次</option>
                                <option value="3" selected>3 次</option>
                                <option value="4">4 次</option>
                                <option value="5">5 次</option>
                            </select>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3 mb-0">
                        <div class="small">链接为只读访问，查看后立刻计数并可随时失效。请仅共享给可信任的对象。</div>
                    </div>
                </form>
                <div id="shareLinkResult" class="d-none mt-3">
                    <div class="card border-success">
                        <div class="card-body">
                            <p class="text-success fw-semibold mb-2">
                                链接已生成，请尽快发送给接收者。
                            </p>
                            <div class="input-group">
                                <input type="text" class="form-control" id="shareLinkUrl" readonly>
                                <button class="btn btn-outline-success" id="shareLinkCopyBtn" type="button">复制</button>
                            </div>
                            <ul class="list-unstyled small text-muted mt-3 mb-0" id="shareLinkSummary"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="shareLinkSubmitBtn">
                    <span class="spinner-border spinner-border-sm me-2 d-none" id="shareLinkSpinner" role="status" aria-hidden="true"></span>
                    生成链接
                </button>
                <button type="button" class="btn btn-outline-danger d-none" id="shareLinkInvalidateBtn">立即失效</button>
            </div>
        </div>
    </div>
</div>

{% include 'totp/add_modal.html' %}
{% include 'totp/import_modal.html' %}
{% include 'totp/add_group_modal.html' %}
{% endblock %}

{% block scripts %}
<script>
(function () {
  const tbody = document.getElementById('tbody');
  if (!tbody) {
    return;
  }

  const countdownEl = document.getElementById('countdown');
  const importPreviewUrl = "{% url 'totp:batch_import_preview' %}";
  const importApplyUrl = "{% url 'totp:batch_import_apply' %}";

  const state = new Map();
  let cycleRemaining = 30;
  let refreshTimer = null;
  let pendingRequest = null;

  const form = document.getElementById('searchForm');
  const qInput = document.getElementById('q');
  const groupSelect = document.getElementById('group');
  const clearBtn = document.getElementById('clearBtn');
  const searchBtn = document.getElementById('searchBtn');
  const spinner = document.getElementById('searchSpinner');

  function initRows() {
    state.clear();
    tbody.querySelectorAll('tr[data-id]').forEach((tr) => {
      const id = Number(tr.dataset.id);
      if (!Number.isFinite(id)) {
        return;
      }
      state.set(id, {
        tr,
        codeEl: tr.querySelector('.code-text'),
        copyBtn: tr.querySelector('.copy-btn'),
        progressEl: tr.querySelector('.progress-bar'),
        remainEl: tr.querySelector('.remain'),
        period: Number(tr.dataset.period) || 30,
        lastCode: null,
        lastRemain: null,
      });
    });
  }

  function setCountdown(value) {
    cycleRemaining = Math.max(0, value);
    if (countdownEl) {
      countdownEl.textContent = cycleRemaining;
    }
  }

  function renderRow(row, code, remain, period) {
    if (code && code !== row.lastCode && row.codeEl) {
      row.codeEl.textContent = code;
      row.lastCode = code;
    }
    if (row.copyBtn && code && row.copyBtn.dataset.code !== code) {
      row.copyBtn.dataset.code = code;
    }
    if (row.remainEl && remain !== row.lastRemain) {
      row.remainEl.textContent = `${remain}s`;
      row.lastRemain = remain;
    }
    if (row.progressEl) {
      const safePeriod = period > 0 ? period : 30;
      const pct = Math.min(100, Math.max(0, Math.round(((safePeriod - remain) / safePeriod) * 100)));
      row.progressEl.style.width = `${pct}%`;
    }
  }

  async function refreshTokens() {
    if (pendingRequest) {
      return pendingRequest;
    }
    pendingRequest = fetch('{% url "totp:api_tokens" %}', {
      headers: { 'X-Requested-With': 'fetch' },
      cache: 'no-store',
    })
      .then(async (resp) => {
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        return resp.json();
      })
      .then((data) => {
        const remaining = Number(data.remaining ?? 30);
        setCountdown(Number.isFinite(remaining) ? remaining : 30);
        const items = new Map((data.items || []).map((item) => [Number(item.id), item]));
        state.forEach((row, id) => {
          const payload = items.get(id);
          if (!payload) {
            return;
          }
          const period = Number(payload.period) || row.period;
          row.period = period;
          renderRow(row, payload.code, cycleRemaining, period);
        });
      })
      .catch((err) => {
        console.error('Refresh tokens failed:', err);
      })
      .finally(() => {
        pendingRequest = null;
      });
    return pendingRequest;
  }

  function scheduleTicker() {
    clearInterval(refreshTimer);
    refreshTimer = setInterval(() => {
      if (cycleRemaining <= 1) {
        refreshTokens();
        return;
      }
      setCountdown(cycleRemaining - 1);
      state.forEach((row) => {
        renderRow(row, row.lastCode, cycleRemaining, row.period);
      });
    }, 1000);
  }

  async function bootstrapTicker() {
    initRows();
    await refreshTokens();
    scheduleTicker();
  }

  function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      return navigator.clipboard.writeText(text);
    }
    const temp = document.createElement('textarea');
    temp.value = text;
    temp.style.position = 'fixed';
    temp.style.opacity = '0';
    document.body.appendChild(temp);
    temp.focus({ preventScroll: true });
    temp.select();
    try {
      document.execCommand('copy');
    } finally {
      document.body.removeChild(temp);
    }
    return Promise.resolve();
  }

  tbody.addEventListener('click', (event) => {
    const btn = event.target.closest('.copy-btn');
    if (!btn || !btn.dataset.code) {
      return;
    }
    const original = btn.dataset.labelDefault || btn.innerHTML;
    copyToClipboard(btn.dataset.code)
      .then(() => {
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');
        btn.innerHTML = '已复制';
        setTimeout(() => {
          btn.classList.remove('btn-success');
          btn.classList.add('btn-outline-secondary');
          btn.innerHTML = original;
        }, 1200);
      })
      .catch((err) => {
        console.error('Copy failed:', err);
      });
  });

  bootstrapTicker();

  function getCsrfToken() {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? decodeURIComponent(match[1]) : '';
  }

  function setButtonLoading(button, loading, label) {
    if (!button) {
      return;
    }
    if (loading) {
      button.disabled = true;
      if (!button.dataset.originalLabel) {
        button.dataset.originalLabel = button.innerHTML;
      }
      const text = label || button.dataset.originalLabel || '';
      button.innerHTML = `<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>${text}`;
    } else {
      button.disabled = false;
      if (button.dataset.originalLabel) {
        button.innerHTML = button.dataset.originalLabel;
        delete button.dataset.originalLabel;
      }
    }
  }

  const importModalEl = document.getElementById('importModal');
  const importModeRadios = importModalEl ? importModalEl.querySelectorAll('input[name="importMode"]') : [];
  const importManualPanel = document.getElementById('importManualPanel');
  const importManualText = document.getElementById('importManualText');
  const importFilePanel = document.getElementById('importFilePanel');
  const importFileInput = document.getElementById('importFileInput');
  const importPreviewBtn = document.getElementById('importPreviewBtn');
  const importApplyBtn = document.getElementById('importApplyBtn');
  const importErrorAlert = document.getElementById('importErrorAlert');
  const importWarningAlert = document.getElementById('importWarningAlert');
  const importWarningList = document.getElementById('importWarningList');
  const importPreviewWrapper = document.getElementById('importPreviewWrapper');
  const importPreviewBody = document.getElementById('importPreviewBody');
  const importPreviewSummary = document.getElementById('importPreviewSummary');
  let importPreviewPayload = null;

  function currentImportMode() {
    const active = Array.from(importModeRadios).find((radio) => radio.checked);
    return active ? active.value : 'manual';
  }

  function hideImportFeedback() {
    importErrorAlert?.classList.add('d-none');
    if (importWarningAlert && importWarningList) {
      importWarningAlert.classList.add('d-none');
      importWarningList.replaceChildren();
    }
  }

  function setImportMode(mode) {
    if (mode === 'file') {
      importManualPanel?.classList.add('d-none');
      importFilePanel?.classList.remove('d-none');
    } else {
      importManualPanel?.classList.remove('d-none');
      importFilePanel?.classList.add('d-none');
    }
    hideImportFeedback();
    importPreviewPayload = null;
    importPreviewWrapper?.classList.add('d-none');
    if (importApplyBtn) {
      importApplyBtn.classList.add('d-none');
      importApplyBtn.disabled = true;
    }
    setButtonLoading(importPreviewBtn, false);
  }

  function resetImportModal() {
    importPreviewPayload = null;
    if (importManualText) {
      importManualText.value = '';
    }
    if (importFileInput) {
      importFileInput.value = '';
    }
    hideImportFeedback();
    importPreviewWrapper?.classList.add('d-none');
    importPreviewBody?.replaceChildren();
    if (importPreviewSummary) {
      importPreviewSummary.textContent = '预览结果如下，请确认后导入：';
    }
    if (importApplyBtn) {
      importApplyBtn.classList.add('d-none');
      importApplyBtn.disabled = true;
      delete importApplyBtn.dataset.originalLabel;
      importApplyBtn.innerHTML = '确认导入';
    }
    setButtonLoading(importPreviewBtn, false);
    if (importModeRadios.length) {
      importModeRadios.forEach((radio) => {
        radio.checked = radio.value === 'manual';
      });
      setImportMode('manual');
    }
  }

  function showImportError(message) {
    if (!importErrorAlert) {
      return;
    }
    importErrorAlert.textContent = message;
    importErrorAlert.classList.toggle('d-none', !message);
  }

  function showImportWarnings(warnings) {
    if (!importWarningAlert || !importWarningList) {
      return;
    }
    importWarningList.replaceChildren();
    if (warnings && warnings.length) {
      warnings.forEach((text) => {
        const li = document.createElement('li');
        li.textContent = text;
        importWarningList.appendChild(li);
      });
      importWarningAlert.classList.remove('d-none');
    } else {
      importWarningAlert.classList.add('d-none');
    }
  }

  function renderImportPreview(entries, summary) {
    if (!importPreviewWrapper || !importPreviewBody) {
      return;
    }
    importPreviewBody.replaceChildren();
    entries.forEach((entry) => {
      const tr = document.createElement('tr');
      const status = entry.exists
        ? '<span class="badge text-bg-secondary">已存在</span>'
        : '<span class="badge text-bg-success">新建</span>';
      tr.innerHTML = `
        <td>${entry.name || '—'}</td>
        <td>${entry.group || '—'}</td>
        <td>${entry.source || '—'}</td>
        <td>${status}</td>
        <td><code>${entry.secret_preview || ''}</code></td>
      `;
      importPreviewBody.appendChild(tr);
    });
    if (importPreviewSummary && summary) {
      importPreviewSummary.textContent = `共 ${summary.total} 条，预计新增 ${summary.new} 条，跳过 ${summary.existing} 条重复。`;
    }
    importPreviewWrapper.classList.remove('d-none');
  }

  if (importModeRadios.length) {
    importModeRadios.forEach((radio) => {
      radio.addEventListener('change', () => setImportMode(radio.value));
    });
    setImportMode(currentImportMode());
  }

  importPreviewBtn?.addEventListener('click', () => {
    hideImportFeedback();
    importPreviewWrapper?.classList.add('d-none');
    importPreviewPayload = null;
    const mode = currentImportMode();
    const formData = new FormData();
    formData.append('mode', mode);

    if (mode === 'file') {
      const file = importFileInput?.files?.[0];
      if (!file) {
        showImportError('请选择要导入的文件');
        return;
      }
      formData.append('file', file);
    } else {
      const value = importManualText?.value.trim() || '';
      if (!value) {
        showImportError('请粘贴待导入的内容');
        return;
      }
      formData.append('manual_text', value);
    }

    setButtonLoading(importPreviewBtn, true, '解析中...');

    fetch(importPreviewUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCsrfToken(),
      },
      body: formData,
      credentials: 'same-origin',
    })
      .then(async (resp) => {
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.ok) {
          const message = (data.errors && data.errors[0]) || data.error || '解析失败，请检查格式';
          throw new Error(message);
        }
        importPreviewPayload = data.entries.map((entry) => ({
          name: entry.name,
          group: entry.group,
          secret: entry.secret,
          source: entry.source,
        }));
        renderImportPreview(data.entries, data.summary);
        showImportWarnings(data.warnings || []);
        if (importApplyBtn) {
          importApplyBtn.classList.remove('d-none');
          importApplyBtn.disabled = false;
        }
      })
      .catch((err) => {
        showImportError(err.message || '解析失败，请稍后再试');
      })
      .finally(() => {
        setButtonLoading(importPreviewBtn, false);
      });
  });

  importApplyBtn?.addEventListener('click', () => {
    if (!importPreviewPayload || !importPreviewPayload.length) {
      showImportError('请先完成预览');
      return;
    }
    setButtonLoading(importApplyBtn, true, '导入中...');
    fetch(importApplyUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken(),
      },
      body: JSON.stringify({ entries: importPreviewPayload }),
      credentials: 'same-origin',
    })
      .then(async (resp) => {
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.ok) {
          const message = data.error || '导入失败，请稍后再试';
          throw new Error(message);
        }
        if (data.redirect) {
          window.location.href = data.redirect;
        } else {
          window.location.reload();
        }
      })
      .catch((err) => {
        showImportError(err.message || '导入失败，请稍后再试');
        setButtonLoading(importApplyBtn, false);
      });
  });

  importModalEl?.addEventListener('hidden.bs.modal', () => {
    resetImportModal();
  });

  tbody.addEventListener('change', (event) => {
    const select = event.target.closest('.group-select');
    if (!select) {
      return;
    }
    const tr = select.closest('tr[data-update-url]');
    if (!tr) {
      return;
    }
    const url = tr.dataset.updateUrl;
    const previous = select.dataset.current ?? '';
    const value = select.value;
    select.disabled = true;
    select.classList.remove('is-valid', 'is-invalid');
    const formData = new FormData();
    formData.append('group_id', value);
    fetch(url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'fetch',
        'X-CSRFToken': getCsrfToken(),
      },
      body: formData,
    })
      .then((resp) => {
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        return resp.json();
      })
      .then(() => {
        select.dataset.current = value;
        select.classList.add('is-valid');
        setTimeout(() => select.classList.remove('is-valid'), 1200);
      })
      .catch((err) => {
        console.error('Update group failed:', err);
        select.value = previous;
        select.classList.add('is-invalid');
        setTimeout(() => select.classList.remove('is-invalid'), 1500);
      })
      .finally(() => {
        select.disabled = false;
      });
  });

  function updateClearButton() {
    const hasValue = (qInput && qInput.value.trim()) || (groupSelect && groupSelect.value);
    if (clearBtn) {
      clearBtn.classList.toggle('d-none', !hasValue);
    }
  }

  updateClearButton();

  if (qInput) {
    qInput.addEventListener('input', updateClearButton);
  }
  if (groupSelect) {
    groupSelect.addEventListener('change', updateClearButton);
  }

  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      if (qInput) {
        qInput.value = '';
      }
      if (groupSelect) {
        groupSelect.value = '';
      }
      updateClearButton();
      if (form) {
        form.submit();
      }
    });
  }

  if (form) {
    form.addEventListener('submit', () => {
      if (qInput) {
        qInput.value = qInput.value.trim();
      }
      if (searchBtn) {
        searchBtn.disabled = true;
      }
      if (spinner) {
        spinner.classList.remove('d-none');
      }
    });
  }

  const addGroupModalEl = document.getElementById('addGroupModal');
  const groupManageList = document.getElementById('groupManageList');
  const groupManageAlert = document.getElementById('groupManageAlert');
  const groupManageEmpty = document.getElementById('groupManageEmpty');

  function clearGroupManageAlert() {
    if (!groupManageAlert) {
      return;
    }
    groupManageAlert.classList.add('d-none');
    groupManageAlert.classList.remove('alert-success', 'alert-warning', 'alert-danger', 'alert-info');
    groupManageAlert.textContent = '';
  }

  function showGroupManageAlert(kind, message) {
    if (!groupManageAlert) {
      return;
    }
    const level = kind === 'success' ? 'alert-success' : kind === 'warning' ? 'alert-warning' : 'alert-danger';
    groupManageAlert.classList.remove('d-none', 'alert-success', 'alert-warning', 'alert-danger', 'alert-info');
    groupManageAlert.classList.add(level);
    groupManageAlert.textContent = message;
  }

  function refreshGroupManageEmptyState() {
    if (!groupManageList || !groupManageEmpty) {
      return;
    }
    const hasItems = Boolean(groupManageList.querySelector('[data-group-id]'));
    groupManageEmpty.classList.toggle('d-none', hasItems);
  }

  function setGroupRowPending(row, pending, activeBtn, label) {
    const input = row.querySelector('.group-name-input');
    if (input) {
      input.disabled = pending;
    }
    row.querySelectorAll('button').forEach((btn) => {
      if (pending) {
        btn.disabled = true;
        if (btn === activeBtn) {
          if (!btn.dataset.originalLabel) {
            btn.dataset.originalLabel = btn.innerHTML;
          }
          const spinnerHtml = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>';
          btn.innerHTML = `${spinnerHtml}${label || ''}`;
        }
      } else {
        btn.disabled = false;
        if (btn.dataset.originalLabel) {
          btn.innerHTML = btn.dataset.originalLabel;
          delete btn.dataset.originalLabel;
        }
      }
    });
  }

  function updateGroupOptions(groupId, label) {
    if (!groupId) {
      return;
    }
    const value = String(groupId);
    const filterSelect = document.getElementById('group');
    const filterOption = filterSelect ? filterSelect.querySelector(`option[value="${value}"]`) : null;
    if (filterOption) {
      filterOption.textContent = label;
    }
    document.querySelectorAll('select.group-select').forEach((select) => {
      const option = select.querySelector(`option[value="${value}"]`);
      if (option) {
        option.textContent = label;
      }
    });
  }

  function removeGroupOptions(groupId) {
    if (!groupId) {
      return;
    }
    const value = String(groupId);
    const filterSelect = document.getElementById('group');
    const filterOption = filterSelect ? filterSelect.querySelector(`option[value="${value}"]`) : null;
    filterOption?.remove();
    document.querySelectorAll('select.group-select').forEach((select) => {
      const option = select.querySelector(`option[value="${value}"]`);
      if (option) {
        if (select.value === value) {
          select.value = '';
          select.dataset.current = '';
        }
        option.remove();
      }
    });
  }

  function handleGroupRename(row, trigger) {
    const input = row.querySelector('.group-name-input');
    const url = row.dataset.renameUrl;
    if (!input || !url) {
      return;
    }
    const newName = (input.value || '').trim();
    if (!newName) {
      showGroupManageAlert('error', '分组名称不能为空');
      input.focus();
      return;
    }
    clearGroupManageAlert();
    setGroupRowPending(row, true, trigger, '保存中...');
    const payload = new URLSearchParams();
    payload.append('name', newName);
    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
        'X-CSRFToken': getCsrfToken(),
        'X-Requested-With': 'fetch',
      },
      body: payload,
      credentials: 'same-origin',
    })
      .then(async (resp) => {
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.ok) {
          const message = data.message || '保存失败，请稍后再试';
          throw new Error(message);
        }
        return data;
      })
      .then((data) => {
        input.value = data.name;
        updateGroupOptions(row.dataset.groupId, data.name);
        showGroupManageAlert('success', '分组名称已更新');
      })
      .catch((err) => {
        showGroupManageAlert('error', err.message || '保存失败，请稍后再试');
      })
      .finally(() => {
        setGroupRowPending(row, false, trigger);
      });
  }

  function handleGroupDelete(row, trigger) {
    const url = row.dataset.deleteUrl;
    const groupId = row.dataset.groupId;
    if (!url || !groupId) {
      return;
    }
    const count = Number(row.dataset.entryCount || '0');
    const confirmed = window.confirm(
      count > 0
        ? `该分组下还有 ${count} 条密钥，删除后将移动到“未分组”。是否继续？`
        : '确定删除该分组？'
    );
    if (!confirmed) {
      return;
    }
    clearGroupManageAlert();
    setGroupRowPending(row, true, trigger, '删除中...');
    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCsrfToken(),
        'X-Requested-With': 'fetch',
      },
      credentials: 'same-origin',
    })
      .then(async (resp) => {
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.ok) {
          const message = data.message || '删除失败，请稍后再试';
          throw new Error(message);
        }
        return data;
      })
      .then((data) => {
        removeGroupOptions(groupId);
        row.remove();
        refreshGroupManageEmptyState();
        const released = Number.isFinite(Number(data.released_entries)) ? Number(data.released_entries) : 0;
        showGroupManageAlert(
          'success',
          released > 0
            ? `已删除分组，${released} 条密钥已移动到“未分组”`
            : '已删除分组'
        );
      })
      .catch((err) => {
        showGroupManageAlert('error', err.message || '删除失败，请稍后再试');
      })
      .finally(() => {
        setGroupRowPending(row, false, trigger);
      });
  }

  groupManageList?.addEventListener('click', (event) => {
    const row = event.target.closest('[data-group-id]');
    if (!row) {
      return;
    }
    if (event.target.closest('.group-save-btn')) {
      handleGroupRename(row, event.target.closest('button'));
    } else if (event.target.closest('.group-delete-btn')) {
      handleGroupDelete(row, event.target.closest('button'));
    }
  });

  groupManageList?.addEventListener('keydown', (event) => {
    if (event.key !== 'Enter') {
      return;
    }
    const input = event.target.closest('.group-name-input');
    if (!input) {
      return;
    }
    event.preventDefault();
    const row = input.closest('[data-group-id]');
    if (row) {
      handleGroupRename(row, row.querySelector('.group-save-btn'));
    }
  });

  addGroupModalEl?.addEventListener('hidden.bs.modal', () => {
    clearGroupManageAlert();
  });

  refreshGroupManageEmptyState();

  const shareModalEl = document.getElementById('shareLinkModal');
  const shareLinkEntryLabel = document.getElementById('shareLinkEntryLabel');
  const shareLinkEntryId = document.getElementById('shareLinkEntryId');
  const shareLinkDuration = document.getElementById('shareLinkDuration');
  const shareLinkMaxViews = document.getElementById('shareLinkMaxViews');
  const shareLinkResult = document.getElementById('shareLinkResult');
  const shareLinkAlert = document.getElementById('shareLinkAlert');
  const shareLinkUrl = document.getElementById('shareLinkUrl');
  const shareLinkCopyBtn = document.getElementById('shareLinkCopyBtn');
  const shareLinkSubmitBtn = document.getElementById('shareLinkSubmitBtn');
  const shareLinkSpinner = document.getElementById('shareLinkSpinner');
  const shareLinkSummary = document.getElementById('shareLinkSummary');
  const shareLinkInvalidateBtn = document.getElementById('shareLinkInvalidateBtn');

  const exportPlainBtn = document.getElementById('exportPlainBtn');
  const exportOfflineBtn = document.getElementById('exportOfflineBtn');

  exportPlainBtn?.addEventListener('click', (event) => {
    const ok = window.confirm('导出文件会包含所有密钥明文，请确认当前环境安全，是否继续？');
    if (!ok) {
      event.preventDefault();
    }
  });

  exportOfflineBtn?.addEventListener('click', (event) => {
    const ok = window.confirm('导出离线包会在本地保存全部密钥明文，使用完毕后请及时销毁文件。确认生成吗？');
    if (!ok) {
      event.preventDefault();
    }
  });

  function resetShareModal() {
    if (shareLinkAlert) {
      shareLinkAlert.classList.add('d-none');
      shareLinkAlert.classList.remove('alert-success');
      shareLinkAlert.classList.add('alert-danger');
      shareLinkAlert.textContent = '';
    }
    shareLinkResult?.classList.add('d-none');
    if (shareLinkUrl) {
      shareLinkUrl.value = '';
    }
    shareLinkSummary?.replaceChildren();
    if (shareLinkInvalidateBtn) {
      shareLinkInvalidateBtn.classList.add('d-none');
      shareLinkInvalidateBtn.dataset.linkId = '';
      shareLinkInvalidateBtn.disabled = false;
    }
    if (shareLinkDuration) {
      shareLinkDuration.value = '10';
    }
    if (shareLinkMaxViews) {
      shareLinkMaxViews.value = '3';
    }
    if (shareLinkSpinner) {
      shareLinkSpinner.classList.add('d-none');
    }
    if (shareLinkSubmitBtn) {
      shareLinkSubmitBtn.disabled = false;
    }
  }

  function setShareSubmitting(flag) {
    if (!shareLinkSubmitBtn) {
      return;
    }
    shareLinkSubmitBtn.disabled = flag;
    if (shareLinkSpinner) {
      shareLinkSpinner.classList.toggle('d-none', !flag);
    }
  }

  function renderShareSummary(payload) {
    if (!shareLinkSummary) {
      return;
    }
    shareLinkSummary.replaceChildren();
    if (!payload) {
      return;
    }
    if (payload.expires_at) {
      const expires = new Date(payload.expires_at);
      const li = document.createElement('li');
      li.textContent = `有效期至：${expires.toLocaleString()}`;
      shareLinkSummary.appendChild(li);
    }
    if (typeof payload.max_views !== 'undefined') {
      const remaining = payload.remaining_views ?? Math.max(0, payload.max_views - 1);
      const li = document.createElement('li');
      li.textContent = `最多查看 ${payload.max_views} 次，目前还可查看 ${remaining} 次。`;
      shareLinkSummary.appendChild(li);
    }
  }

  tbody.addEventListener('click', (event) => {
    const trigger = event.target.closest('.share-link-btn');
    if (!trigger || !shareModalEl || !shareLinkEntryId || !shareLinkEntryLabel) {
      return;
    }
    const entryId = trigger.dataset.entryId;
    const entryName = trigger.dataset.entryName || `#${entryId}`;
    shareLinkEntryId.value = entryId;
    shareLinkEntryLabel.textContent = entryName;
    resetShareModal();
    if (window.bootstrap && typeof window.bootstrap.Modal === 'function') {
      window.bootstrap.Modal.getOrCreateInstance(shareModalEl).show();
    }
  });

  shareModalEl?.addEventListener('hidden.bs.modal', () => {
    if (shareLinkEntryId) {
      shareLinkEntryId.value = '';
    }
    resetShareModal();
  });

  shareLinkSubmitBtn?.addEventListener('click', () => {
    if (!shareLinkEntryId?.value) {
      return;
    }
    shareLinkAlert?.classList.add('d-none');
    setShareSubmitting(true);
    const formData = new FormData();
    formData.append('duration', shareLinkDuration?.value || '10');
    formData.append('max_views', shareLinkMaxViews?.value || '3');

    const createUrl = `{% url 'totp:one_time_create' 0 %}`.replace('/0/', `/${shareLinkEntryId.value}/`);

    fetch(createUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCsrfToken(),
        'X-Requested-With': 'fetch',
      },
      body: formData,
    })
      .then(async (resp) => {
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.ok) {
          const message = data.message || '生成链接失败，请稍后重试。';
          throw new Error(message);
        }
        if (shareLinkUrl) {
          shareLinkUrl.value = data.url;
        }
        renderShareSummary(data);
        shareLinkResult?.classList.remove('d-none');
        if (shareLinkInvalidateBtn) {
          shareLinkInvalidateBtn.classList.remove('d-none');
          shareLinkInvalidateBtn.dataset.linkId = String(data.id);
        }
      })
      .catch((err) => {
        if (shareLinkAlert) {
          shareLinkAlert.textContent = err.message;
          shareLinkAlert.classList.remove('d-none');
        }
      })
      .finally(() => setShareSubmitting(false));
  });

  shareLinkCopyBtn?.addEventListener('click', () => {
    if (!shareLinkUrl?.value) {
      return;
    }
    copyToClipboard(shareLinkUrl.value)
      .then(() => {
        shareLinkCopyBtn.classList.remove('btn-outline-success');
        shareLinkCopyBtn.classList.add('btn-success');
        shareLinkCopyBtn.textContent = '已复制';
        setTimeout(() => {
          shareLinkCopyBtn.classList.remove('btn-success');
          shareLinkCopyBtn.classList.add('btn-outline-success');
          shareLinkCopyBtn.textContent = '复制';
        }, 1600);
      })
      .catch(() => {
        if (shareLinkAlert) {
          shareLinkAlert.textContent = '复制失败，请手动复制链接。';
          shareLinkAlert.classList.remove('d-none');
        }
      });
  });

  shareLinkInvalidateBtn?.addEventListener('click', () => {
    const linkId = shareLinkInvalidateBtn.dataset.linkId;
    if (!linkId) {
      return;
    }
    const invalidateUrl = `{% url 'totp:one_time_invalidate' 0 %}`.replace('/0/', `/${linkId}/`);
    shareLinkInvalidateBtn.disabled = true;
    fetch(invalidateUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCsrfToken(),
        'X-Requested-With': 'fetch',
      },
    })
      .then((resp) => {
        if (!resp.ok) {
          throw new Error('未能立即失效，请稍后再试。');
        }
        if (shareLinkAlert) {
          shareLinkAlert.classList.remove('alert-danger');
          shareLinkAlert.classList.add('alert-success');
          shareLinkAlert.textContent = '链接已失效。';
          shareLinkAlert.classList.remove('d-none');
        }
        shareLinkInvalidateBtn.classList.add('d-none');
        shareLinkInvalidateBtn.dataset.linkId = '';
      })
      .catch((err) => {
        if (shareLinkAlert) {
          shareLinkAlert.textContent = err.message;
          shareLinkAlert.classList.remove('d-none');
        }
      })
      .finally(() => {
        shareLinkInvalidateBtn.disabled = false;
      });
  });

  const params = new URLSearchParams(window.location.search);
  const modal = params.get('modal');
  if (modal === 'add' || modal === 'import') {
    const id = modal === 'add' ? 'addModal' : 'importModal';
    const element = document.getElementById(id);
    if (element && window.bootstrap && typeof window.bootstrap.Modal === 'function') {
      new window.bootstrap.Modal(element).show();
    }
  }
})();
</script>
{% endblock %}
