{% extends 'base.html' %}
{% block title %}我的密钥-TOTP管理平台{% endblock %}
{% block head %}
{{ block.super }}
<style>
    .search-group { white-space: nowrap; }
    .search-input { width: min(100%, 420px); }
    .search-group .btn { white-space: nowrap; }
    @media (max-width: 576px) {
        .search-input { width: 100%; }
    }
</style>
{% endblock %}

{% block content %}

<div class="mb-3">
    <div class="row g-2 align-items-center">
        <div class="col-12 col-md-auto order-1">
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal" type="button">
                    添加密钥
                </button>
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importModal"
                        type="button">批量导入
                </button>
                <a class="btn btn-outline-secondary" href="{% url 'totp:export' %}">
                    导出密钥
                </a>
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addGroupModal"
                        type="button">添加分组
                </button>
                <a class="btn btn-outline-danger" href="{% url 'totp:trash' %}">回收站</a>
            </div>
        </div>
        <div class="col-12 col-md order-2 order-md-2">
            <form id="searchForm" class="d-flex justify-content-md-end" method="get" role="search"
                  aria-label="按名称搜索">
                <div class="input-group flex-nowrap w-100 w-md-auto search-group ms-md-auto">
                    <select id="group" name="group" class="form-select">
                        <option value="">全部分组</option>
                        <option value="0" {% if group_id == '0' %}selected{% endif %}>未分组</option>
                        {% for g in groups %}
                        <option value="{{ g.id }}" {% if group_id|default:'' == g.id|stringformat:'s' %}selected{% endif %}>{{ g.name }}</option>
                        {% endfor %}
                    </select>
                    <span class="input-group-text bg-transparent">
                        <svg width="18" height="18" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7" stroke="currentColor" fill="none" stroke-width="2"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                    </span>
                    <input id="q" name="q" value="{{ q|default_if_none:'' }}" class="form-control search-input"
                           type="search" placeholder="仅按名称搜索" autocomplete="off" enterkeyhint="search"
                           spellcheck="false" maxlength="64">
                    <button class="btn btn-outline-secondary d-none" id="clearBtn" type="button" aria-label="清空搜索">
                        清空
                    </button>
                    <button class="btn btn-primary" type="submit" id="searchBtn"><span
                            class="spinner-border spinner-border-sm me-1 d-none" id="searchSpinner" role="status"
                            aria-hidden="true"></span>搜索
                    </button>
                    {% if q or group_id %}<a class="btn btn-outline-secondary" href="{% url 'totp:list' %}">重置</a>{% endif %}
                </div>
            </form>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <strong>我的密钥</strong>
        <div>下次刷新倒计时：<span id="countdown">--</span>s</div>
    </div>
    <div class="table-responsive">
        <table class="table table-hover table-striped mb-0 align-middle" id="totpTable">
            <thead>
            <tr>
                <th>名称</th>
                <th>分组</th>
                <th class="text-nowrap">验证码</th>
                <th class="text-nowrap">有效期</th>
                <th class="text-nowrap">操作</th>
            </tr>
            </thead>
            <tbody id="tbody">
            {% for e in entries %}
            {% include 'totp/_entry_row.html' with e=e groups=groups %}
            {% empty %}
            <tr class="no-data">
                <td colspan="5" class="text-center text-muted py-5">暂无数据</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% if page_obj.has_other_pages %}
    <div class="card-footer">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-0">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link"
                       href="?{% if q %}q={{ q|urlencode }}&amp;{% endif %}{% if group_id %}group={{ group_id }}&amp;{% endif %}page={{ page_obj.previous_page_number }}"
                       aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                {% if num == page_obj.number %}
                <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
                {% else %}
                <li class="page-item"><a class="page-link"
                                         href="?{% if q %}q={{ q|urlencode }}&amp;{% endif %}{% if group_id %}group={{ group_id }}&amp;{% endif %}page={{ num }}">{{ num }}</a></li>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link"
                       href="?{% if q %}q={{ q|urlencode }}&amp;{% endif %}{% if group_id %}group={{ group_id }}&amp;{% endif %}page={{ page_obj.next_page_number }}"
                       aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}

</div>

{% include 'totp/add_modal.html' %}
{% include 'totp/import_modal.html' %}
{% include 'totp/add_group_modal.html' %}
{% endblock %}

{% block scripts %}
<script>
(function () {
  const tbody = document.getElementById('tbody');
  if (!tbody) {
    return;
  }

  const countdownEl = document.getElementById('countdown');
  const state = new Map();
  let cycleRemaining = 30;
  let refreshTimer = null;
  let pendingRequest = null;

  function initRows() {
    state.clear();
    tbody.querySelectorAll('tr[data-id]').forEach((tr) => {
      const id = Number(tr.dataset.id);
      if (!Number.isFinite(id)) {
        return;
      }
      state.set(id, {
        tr,
        codeEl: tr.querySelector('.code-text'),
        copyBtn: tr.querySelector('.copy-btn'),
        progressEl: tr.querySelector('.progress-bar'),
        remainEl: tr.querySelector('.remain'),
        period: Number(tr.dataset.period) || 30,
        lastCode: null,
        lastRemain: null,
      });
    });
  }

  function setCountdown(value) {
    cycleRemaining = Math.max(0, value);
    if (countdownEl) {
      countdownEl.textContent = cycleRemaining;
    }
  }

  function renderRow(row, code, remain, period) {
    if (code && code !== row.lastCode && row.codeEl) {
      row.codeEl.textContent = code;
      row.lastCode = code;
    }
    if (row.copyBtn && code && row.copyBtn.dataset.code !== code) {
      row.copyBtn.dataset.code = code;
    }
    if (row.remainEl && remain !== row.lastRemain) {
      row.remainEl.textContent = `${remain}s`;
      row.lastRemain = remain;
    }
    if (row.progressEl) {
      const safePeriod = period > 0 ? period : 30;
      const pct = Math.min(100, Math.max(0, Math.round(((safePeriod - remain) / safePeriod) * 100)));
      row.progressEl.style.width = `${pct}%`;
    }
  }

  async function refreshTokens() {
    if (pendingRequest) {
      return pendingRequest;
    }
    pendingRequest = fetch('{% url "totp:api_tokens" %}', {
      headers: { 'X-Requested-With': 'fetch' },
      cache: 'no-store',
    })
      .then(async (resp) => {
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        return resp.json();
      })
      .then((data) => {
        const remaining = Number(data.remaining ?? 30);
        setCountdown(Number.isFinite(remaining) ? remaining : 30);
        const items = new Map((data.items || []).map((item) => [Number(item.id), item]));
        state.forEach((row, id) => {
          const payload = items.get(id);
          if (!payload) {
            return;
          }
          const period = Number(payload.period) || row.period;
          row.period = period;
          renderRow(row, payload.code, cycleRemaining, period);
        });
      })
      .catch((err) => {
        console.error('Refresh tokens failed:', err);
      })
      .finally(() => {
        pendingRequest = null;
      });
    return pendingRequest;
  }

  function scheduleTicker() {
    clearInterval(refreshTimer);
    refreshTimer = setInterval(() => {
      if (cycleRemaining <= 1) {
        refreshTokens();
        return;
      }
      setCountdown(cycleRemaining - 1);
      state.forEach((row) => {
        renderRow(row, row.lastCode, cycleRemaining, row.period);
      });
    }, 1000);
  }

  async function bootstrapTicker() {
    initRows();
    await refreshTokens();
    scheduleTicker();
  }

  function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      return navigator.clipboard.writeText(text);
    }
    const temp = document.createElement('textarea');
    temp.value = text;
    temp.style.position = 'fixed';
    temp.style.opacity = '0';
    document.body.appendChild(temp);
    temp.focus({ preventScroll: true });
    temp.select();
    try {
      document.execCommand('copy');
    } finally {
      document.body.removeChild(temp);
    }
    return Promise.resolve();
  }

  tbody.addEventListener('click', (event) => {
    const btn = event.target.closest('.copy-btn');
    if (!btn || !btn.dataset.code) {
      return;
    }
    const original = btn.dataset.labelDefault || btn.innerHTML;
    copyToClipboard(btn.dataset.code)
      .then(() => {
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');
        btn.innerHTML = '已复制';
        setTimeout(() => {
          btn.classList.remove('btn-success');
          btn.classList.add('btn-outline-secondary');
          btn.innerHTML = original;
        }, 1200);
      })
      .catch((err) => {
        console.error('Copy failed:', err);
      });
  });

  function getCsrfToken() {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? decodeURIComponent(match[1]) : '';
  }

  tbody.addEventListener('change', (event) => {
    const select = event.target.closest('.group-select');
    if (!select) {
      return;
    }
    const tr = select.closest('tr[data-update-url]');
    if (!tr) {
      return;
    }
    const url = tr.dataset.updateUrl;
    const previous = select.dataset.current ?? '';
    const value = select.value;
    select.disabled = true;
    select.classList.remove('is-valid', 'is-invalid');
    const formData = new FormData();
    formData.append('group_id', value);
    fetch(url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'fetch',
        'X-CSRFToken': getCsrfToken(),
      },
      body: formData,
    })
      .then((resp) => {
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        return resp.json();
      })
      .then(() => {
        select.dataset.current = value;
        select.classList.add('is-valid');
        setTimeout(() => select.classList.remove('is-valid'), 1200);
      })
      .catch((err) => {
        console.error('Update group failed:', err);
        select.value = previous;
        select.classList.add('is-invalid');
        setTimeout(() => select.classList.remove('is-invalid'), 1500);
      })
      .finally(() => {
        select.disabled = false;
      });
  });

  bootstrapTicker();

  const form = document.getElementById('searchForm');
  const qInput = document.getElementById('q');
  const groupSelect = document.getElementById('group');
  const clearBtn = document.getElementById('clearBtn');
  const searchBtn = document.getElementById('searchBtn');
  const spinner = document.getElementById('searchSpinner');

  function updateClearButton() {
    const hasValue = (qInput && qInput.value.trim()) || (groupSelect && groupSelect.value);
    if (clearBtn) {
      clearBtn.classList.toggle('d-none', !hasValue);
    }
  }

  updateClearButton();

  if (qInput) {
    qInput.addEventListener('input', updateClearButton);
  }
  if (groupSelect) {
    groupSelect.addEventListener('change', updateClearButton);
  }

  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      if (qInput) {
        qInput.value = '';
      }
      if (groupSelect) {
        groupSelect.value = '';
      }
      updateClearButton();
      if (form) {
        form.submit();
      }
    });
  }

  if (form) {
    form.addEventListener('submit', () => {
      if (qInput) {
        qInput.value = qInput.value.trim();
      }
      if (searchBtn) {
        searchBtn.disabled = true;
      }
      if (spinner) {
        spinner.classList.remove('d-none');
      }
    });
  }

  const params = new URLSearchParams(window.location.search);
  const modal = params.get('modal');
  if (modal === 'add' || modal === 'import') {
    const id = modal === 'add' ? 'addModal' : 'importModal';
    const element = document.getElementById(id);
    if (element && window.bootstrap && typeof window.bootstrap.Modal === 'function') {
      new window.bootstrap.Modal(element).show();
    }
  }
})();
</script>
{% endblock %}
