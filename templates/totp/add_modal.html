<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-3 shadow">
            <form method="post" action="{% url 'totp:add' %}">
                {% csrf_token %}
                <div class="modal-header"><h5 class="modal-title">添加密钥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label">名称</label>
                        <input name="name" class="form-control" placeholder="如：GitHub @me" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">空间</label>
                        <select name="team_id" class="form-select" id="entryTeamSelect">
                            <option value="">个人空间</option>
                            {% for m in team_memberships %}
                                {% if m.can_manage_entries %}
                                    <option value="{{ m.team_id }}" {% if selected_team and selected_team.id == m.team_id %}selected{% endif %}>
                                        {{ m.team.name }}{% if m.role != 'member' %} · {{ m.get_role_display }}{% endif %}
                                    </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <div class="form-text">选择保存到个人或具有管理权限的团队空间。</div>
                    </div>
                    <div class="mb-2" data-group-field>
                        <label class="form-label">分组（可选）</label>
                        <select name="group_id" class="form-select">
                            <option value="">未分组</option>
                            {% for g in groups %}
                            <option value="{{ g.id }}">{{ g.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">密钥（Base32）或 otpauth:// URI</label>
                        <textarea id="secretInput" name="secret" rows="2" class="form-control"
                                  placeholder="JBSWY3DPEHPK3PXP 或 otpauth://totp/..." required></textarea>
                        <div class="form-text">可上传二维码图片自动识别；仅解析 label→名称、secret→密钥，忽略 issuer。</div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">二维码图片（可选）</label>
                        <div class="d-flex gap-2">
                            <input type="file" id="qrFile" accept="image/*" class="form-control"/>
                            <button type="button" id="pickFromGallery" class="btn btn-outline-primary">从相册导入</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                    <button class="btn btn-primary" type="submit">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    (function () {
      const ZXING_SRC = 'https://cdn.bootcdn.net/ajax/libs/zxing/0.20.0/zxing.min.js';
      let readerPromise = null;

      function loadScriptOnce(src) {
        return new Promise((resolve, reject) => {
          if (window.ZXing?.BrowserQRCodeReader) {
            resolve(window.ZXing);
            return;
          }
          const existing = document.getElementById('zxing-script');
          if (existing) {
            existing.addEventListener('load', () => resolve(window.ZXing), { once: true });
            existing.addEventListener('error', () => reject(new Error('ZXing 加载失败')), { once: true });
            return;
          }
          const script = document.createElement('script');
          script.id = 'zxing-script';
          script.src = src;
          script.async = true;
          script.onload = () => resolve(window.ZXing);
          script.onerror = () => reject(new Error('ZXing 加载失败'));
          document.head.appendChild(script);
        });
      }

      function ensureCodeReader() {
        if (readerPromise) {
          return readerPromise;
        }
        readerPromise = loadScriptOnce(ZXING_SRC).then((ZXing) => {
          if (!ZXing?.BrowserQRCodeReader) {
            throw new Error('未找到二维码识别器');
          }
          return new ZXing.BrowserQRCodeReader();
        });
        return readerPromise;
      }

      function parseOtpAuth(text) {
        if (!text || typeof text !== 'string' || !text.startsWith('otpauth://')) {
          return null;
        }
        try {
          const url = new URL(text);
          if (url.protocol !== 'otpauth:') return null;
          const rawLabel = decodeURIComponent(url.pathname.replace(/^\/+/, ''));
          const labelParts = rawLabel.split(':');
          const label = (labelParts.length > 1 ? labelParts.slice(1).join(':') : rawLabel).trim();
          const secret = (url.searchParams.get('secret') || '').trim();
          return { label, secret };
        } catch (err) {
          console.error('无法解析 otpauth URI', err);
          return null;
        }
      }

      function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const dataUrl = typeof reader.result === 'string' ? reader.result : '';
            resolve(dataUrl);
          };
          reader.onerror = () => reject(reader.error || new Error('读取文件失败'));
          reader.readAsDataURL(file);
        });
      }

      async function decodeQrFile(file, qrInput) {
        try {
          const codeReader = await ensureCodeReader();
          const dataUrl = await readFileAsDataURL(file);
          if (!dataUrl) {
            alert('未识别到二维码内容');
            return;
          }
          const result = await codeReader.decodeFromImageUrl(dataUrl);
          const text =
            typeof result?.getText === 'function' ? result.getText() : result?.text || '';
          if (!text) {
            alert('未识别到二维码内容');
            return;
          }
          const secretInput = document.getElementById('secretInput');
          const nameInput = document.querySelector('input[name="name"]');
          const parsed = parseOtpAuth(text);
          if (secretInput) {
            secretInput.value = parsed?.secret || text;
          }
          if (parsed?.label && nameInput) {
            nameInput.value = parsed.label;
          }
        } catch (err) {
          alert('解析二维码失败');
          console.error(err);
        } finally {
          if (qrInput) {
            qrInput.value = '';
          }
        }
      }

      function attachListener() {
        const qrInput = document.getElementById('qrFile');
        const pickFromGallery = document.getElementById('pickFromGallery');
        if (!qrInput || !pickFromGallery) {
          return;
        }

        qrInput.addEventListener('change', async (event) => {
          const file = event.target.files?.[0];
          if (!file) {
            return;
          }
          await decodeQrFile(file, qrInput);
        });

        pickFromGallery.addEventListener('click', () => {
          ensureCodeReader().catch((err) => console.error(err));
          qrInput.click();
        });
      }

      if (document.readyState === 'complete') {
        attachListener();
      } else {
        window.addEventListener('load', attachListener, { once: true });
      }

      const addModalEl = document.getElementById('addModal');
      function syncSpaceControls() {
        if (!addModalEl) return;
        const teamSelect = addModalEl.querySelector('#entryTeamSelect');
        const groupField = addModalEl.querySelector('[data-group-field]');
        if (!teamSelect || !groupField) return;
        const groupSelect = groupField.querySelector('select');
        const isTeam = teamSelect.value !== '';
        if (groupSelect) {
          groupSelect.disabled = isTeam;
        }
        groupField.classList.toggle('d-none', isTeam);
      }

      if (addModalEl) {
        addModalEl.addEventListener('shown.bs.modal', syncSpaceControls);
        const teamSelect = addModalEl.querySelector('#entryTeamSelect');
        if (teamSelect) {
          teamSelect.addEventListener('change', syncSpaceControls);
        }
        syncSpaceControls();
      }
    })();
</script>
