<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-3 shadow">
            <form method="post" action="{% url 'totp:add' %}">
                {% csrf_token %}
                <div class="modal-header"><h5 class="modal-title">添加密钥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label">名称</label>
                        <input name="name" class="form-control" placeholder="如：GitHub @me" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">分组（可选）</label>
                        <select name="group_id" class="form-select">
                            <option value="">未分组</option>
                            {% for g in request.user.totp_groups.all %}
                            <option value="{{ g.id }}">{{ g.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">密钥（Base32）或 otpauth:// URI</label>
                        <textarea id="secretInput" name="secret" rows="2" class="form-control"
                                  placeholder="JBSWY3DPEHPK3PXP 或 otpauth://totp/..." required></textarea>
                        <div class="form-text">可上传二维码图片自动识别；仅解析 label→名称、secret→密钥，忽略 issuer。</div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">二维码图片（可选）</label>
                        <input type="file" id="qrFile" accept="image/*" class="form-control"/>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                    <button class="btn btn-primary" type="submit">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    (function () {
     function parseOtpAuth(text) {
       if (!text || typeof text !== 'string' || !text.startsWith('otpauth://')) {
         return null;
       }
       try {
         const url = new URL(text);
         if (url.protocol !== 'otpauth:') return null;
         const rawLabel = decodeURIComponent(url.pathname.replace(/^\/+/, ''));
         const labelParts = rawLabel.split(':');
         const label = (labelParts.length > 1 ? labelParts.slice(1).join(':') : rawLabel).trim();
         const secret = (url.searchParams.get('secret') || '').trim();
         return {label, secret};
       } catch (err) {
         console.error('无法解析 otpauth URI', err);
         return null;
       }
     }

     function attachListener() {
       if (!window.ZXing?.BrowserQRCodeReader) {
         console.error('二维码识别库未加载');
         return;
       }
       const qrInput = document.getElementById('qrFile');
       if (!qrInput) {
         return;
       }
       const codeReader = new ZXing.BrowserQRCodeReader();
       qrInput.addEventListener('change', async (e) => {
         const file = e.target.files?.[0];
         if (!file) return;

         const reader = new FileReader();
         reader.onload = async () => {
           const dataUrl = typeof reader.result === 'string' ? reader.result : '';
           if (!dataUrl) return;
           try {
             const res = await codeReader.decodeFromImageUrl(dataUrl);
             const text = typeof res?.getText === 'function' ? res.getText() : (res?.text || '');
             if (!text) {
               alert('未识别到二维码内容');
               return;
             }

             const secretInput = document.getElementById('secretInput');
             const nameInput = document.querySelector('input[name="name"]');
             const parsed = parseOtpAuth(text);

             if (parsed?.secret) {
               secretInput.value = parsed.secret;
             } else {
               secretInput.value = text;
             }

             if (parsed?.label && nameInput) {
               nameInput.value = parsed.label;
             }
           } catch (err) {
             alert('解析二维码失败');
             console.error(err);
           } finally {
             qrInput.value = '';
           }
         };
         reader.readAsDataURL(file);
       });
     }

     if (document.readyState === 'complete') {
       attachListener();
     } else {
       window.addEventListener('load', attachListener, {once: true});
    }
   })();
</script>
