{% extends 'base.html' %}
{% block title %}2FA在线工具,TOTP管理平台,动态验证码助手{% endblock %}
    <meta name="keywords" content="2FA,2fa,2fa在线工具,2FA Auth,2FA live,2FA Code,双重验证工具,2FA在线工具"/>
    <meta name="description" content="免费的TOTP管理平台,动态验证码助手OTP管理平台,2FA在线工具"/>
{% block content %}
{% if request.user.is_authenticated %}
<div class="container-fluid py-3 py-md-4">

    <!-- 顶部欢迎区 -->
    <div class="bg-white rounded-3 p-4 p-md-5 mb-4 shadow-sm">
        <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
            <div>
                <h1 class="h4 mb-2">欢迎回来，{{ request.user.username }}</h1>
                <p class="text-muted mb-0">集中管理动态口令、掌握核心数据，并随时导入或导出你的密钥。</p>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <!-- 与现有模态框对接 -->
                <button class="btn btn-primary" type="button"
                        data-bs-toggle="modal" data-bs-target="#addModal">添加密钥
                </button>
                <button class="btn btn-outline-primary" type="button"
                        data-bs-toggle="modal" data-bs-target="#importModal">批量导入
                </button>
                <a class="btn btn-outline-secondary" href="{% url 'totp:list' %}">查看全部密钥</a>
            </div>
        </div>
    </div>

    <!-- 关键统计 -->
    <div class="row g-3 g-md-4 mb-4">
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">已保存的密钥</span>
                        <span class="badge bg-primary-subtle text-primary">最新统计</span>
                    </div>
                    <div class="display-6 fw-bold">{{ stats.total_entries|default:0 }}</div>
                    <div class="text-muted small mt-1">系统中已录入的全部 TOTP 项目</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">启用的分组</span>
                        <span class="badge bg-secondary-subtle text-secondary">结构化</span>
                    </div>
                    <div class="display-6 fw-bold">{{ stats.group_count|default:0 }}</div>
                    <div class="text-muted small mt-1">按团队或用途划分，便于快速定位</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">今日新增</span>
                        <span class="badge bg-success-subtle text-success">+</span>
                    </div>
                    <div class="display-6 fw-bold">{{ stats.today_added|default:0 }}</div>
                    <div class="text-muted small mt-1">今日新增的密钥条目</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">当前周期剩余</span>
                        <span class="badge bg-warning-subtle text-warning">倒计时</span>
                    </div>
                    {% with remain=stats.current_cycle_remaining|default:0 total=stats.current_cycle_total|default:30 %}
                    {% if total > 0 %}
                    {% widthratio remain total 100 as pct %}
                    <div class="progress" role="progressbar" aria-label="当前周期剩余" aria-valuemin="0"
                         aria-valuemax="100">
                        <div id="cycle-progress" class="progress-bar" style="width:{{ pct }}%"
                             aria-valuenow="{{ pct }}"></div>
                    </div>
                    <div class="text-muted small mt-1">本周期剩余 <span id="cycle-remaining">{{ remain }}</span> 秒 /
                        <span id="cycle-total">{{ total }}</span> 秒
                    </div>
                    {% else %}
                    <div class="text-muted small">—</div>
                    {% endif %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>

    <!-- 快捷操作 & 使用说明 -->
    <div class="row g-3 g-md-4">
        <div class="col-12 col-lg-7">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0">
                    <div class="d-flex align-items-center justify-content-between">
                        <h2 class="h6 mb-0">快速上手</h2>
                        <a href="{% url 'totp:list' %}" class="btn btn-sm btn-outline-secondary">前往“我的密钥”</a>
                    </div>
                </div>
                <div class="card-body">
                    <ol class="mb-0 ps-3">
                        <li class="mb-2">
                            点击 <strong>添加密钥</strong> 或 <strong>批量导入</strong>，
                            填写名称、所属分组及密钥（支持上传二维码）。
                        </li>
                        <li class="mb-2">在“我的密钥”页面实时查看验证码，并可一键复制。</li>
                        <li class="mb-2">通过分组与搜索快速筛选，支持多账号、多团队协作。</li>
                        <li>如启用加密导出，请妥善保存导出密码，确保数据安全。</li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-5">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0">
                    <h2 class="h6 mb-0">最近活动</h2>
                </div>
                <div class="card-body">
                    {% if recent_entries %}
                    <ul class="list-group list-group-flush">
                        {% for item in recent_entries %}
                        <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                            <div class="me-3">
                                <div class="fw-semibold">{{ item.name }}</div>
                                <div class="text-muted small">分组：{{ item.group_name|default:"未分组" }}</div>
                            </div>
                            <span class="text-muted small">{{ item.created_at|date:"Y-m-d H:i" }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="text-muted small">暂无最近活动记录</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'totp/add_modal.html' %}
{% include 'totp/import_modal.html' %}
{% else %}
<div class="container py-5 text-center">
    <i class="bi bi-shield-lock display-4 text-primary mb-3"></i>
    <h1 class="display-5 mb-3">安全高效的 TOTP 管理中心</h1>
    <p class="lead text-muted mb-4">统一管理动态验证码，轻松完成双重验证(2FA)和团队协作。</p><br />
    <a href="{% url 'accounts:login' %}" class="btn btn-primary btn-lg px-4 me-2">立即登录</a>
    <a href="{% url 'accounts:signup' %}" class="btn btn-outline-primary btn-lg px-4">免费注册</a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if request.user.is_authenticated %}
<script>
    (function(){
      const total = {{ stats.current_cycle_total|default:30 }};
      let remain = {{ stats.current_cycle_remaining|default:0 }};
      const progress = document.getElementById('cycle-progress');
      const remainEl = document.getElementById('cycle-remaining');
      function update(){
        const percent = Math.round(((total - remain) / total) * 100);
        progress.style.width = percent + '%';
        progress.setAttribute('aria-valuenow', percent);
        remainEl.textContent = remain;
        remain = remain <= 1 ? total : remain - 1;
      }
      update();
      setInterval(update, 1000);
    })();
</script>
{% endif %}
{% endblock %}