{% extends 'base.html' %}
{% block title %}2FA在线工具,TOTP管理平台,动态验证码助手{% endblock %}
{% block head %}
{{ block.super }}
<meta name="keywords"
      content="2FA,2fa,2fa在线工具,2FA Auth,2FA live,2FA Code,双重验证工具,2FA在线工具"/>
<meta name="description"
      content="免费的TOTP管理平台,动态验证码助手OTP管理平台,2FA在线工具"/>
{% endblock %}
{% block content %}
{% if request.user.is_authenticated %}
<div class="container-fluid py-3 py-md-4">

    <!-- 顶部欢迎区 -->
    <div class="bg-white rounded-3 p-4 p-md-5 mb-4 shadow-sm">
        <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
            <div>
                <h1 class="h4 mb-2">欢迎回来，{{ request.user.username }}</h1>
                <p class="text-muted mb-0">集中管理动态口令、掌握核心数据，并随时导入或导出你的密钥。</p>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <!-- 与现有模态框对接 -->
                <button class="btn btn-primary" type="button"
                        data-bs-toggle="modal" data-bs-target="#addModal">添加密钥
                </button>
                <button class="btn btn-outline-primary" type="button"
                        data-bs-toggle="modal" data-bs-target="#importModal">批量导入
                </button>
                <a class="btn btn-outline-secondary" href="{% url 'totp:list' %}">查看全部密钥</a>
            </div>
        </div>
    </div>

    <!-- 关键统计 -->
    <div class="row g-3 g-md-4 mb-4">
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">已保存的密钥</span>
                        <span class="badge bg-primary-subtle text-primary">最新统计</span>
                    </div>
                    <div class="display-6 fw-bold">{{ stats.total_entries|default:0 }}</div>
                    <div class="text-muted small mt-1">系统中已录入的全部 TOTP 项目</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">启用的分组</span>
                        <span class="badge bg-secondary-subtle text-secondary">结构化</span>
                    </div>
                    <div class="display-6 fw-bold">{{ stats.group_count|default:0 }}</div>
                    <div class="text-muted small mt-1">按团队或用途划分，便于快速定位</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">今日新增</span>
                        <span class="badge bg-success-subtle text-success">+</span>
                    </div>
                    <div class="display-6 fw-bold">{{ stats.today_added|default:0 }}</div>
                    <div class="text-muted small mt-1">今日新增的密钥条目</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">当前周期剩余</span>
                        <span class="badge bg-warning-subtle text-warning">倒计时</span>
                    </div>
                    {% with remain=stats.current_cycle_remaining|default:0 total=stats.current_cycle_total|default:30 %}
                    {% if total > 0 %}
                    {% widthratio remain total 100 as pct %}
                    <div class="progress" role="progressbar" aria-label="当前周期剩余" aria-valuemin="0"
                         aria-valuemax="100">
                        <div id="cycle-progress" class="progress-bar" style="width:{{ pct }}%"
                             aria-valuenow="{{ pct }}"></div>
                    </div>
                    <div class="text-muted small mt-1">本周期剩余 <span id="cycle-remaining">{{ remain }}</span> 秒 /
                        <span id="cycle-total">{{ total }}</span> 秒
                    </div>
                    {% else %}
                    <div class="text-muted small">—</div>
                    {% endif %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>

    <!-- 快捷操作 & 使用说明 -->
    <div class="row g-3 g-md-4">
        <div class="col-12 col-lg-7">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0">
                    <div class="d-flex align-items-center justify-content-between">
                        <h2 class="h6 mb-0">快速上手</h2>
                        <a href="{% url 'totp:list' %}" class="btn btn-sm btn-outline-secondary">前往“我的密钥”</a>
                    </div>
                </div>
                <div class="card-body">
                    <ol class="mb-0 ps-3">
                        <li class="mb-2">点击 <strong>添加密钥</strong> 或 <strong>批量导入</strong>，在预览中确认条目后即可一键写入。</li>
                        <li class="mb-2">前往“我的密钥”实时查看验证码、复制或快速分组调整。</li>
                        <li class="mb-2">需要安全分享时，使用<strong>一次性链接</strong>功能，设置有效期与查看次数后再发送给接收者。</li>
                        <li class="mb-2">善用搜索与分组过滤快速定位条目，支持个人与团队协作。</li>
                        <li>需要备份时，可导出明文或离线包，请在安全环境保存与使用。</li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-5">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0">
                    <h2 class="h6 mb-0">最近活动</h2>
                </div>
                <div class="card-body">
                    {% if recent_entries %}
                    <ul class="list-group list-group-flush">
                        {% for item in recent_entries %}
                        <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                            <div class="me-3">
                                <div class="fw-semibold">{{ item.name }}</div>
                                <div class="text-muted small">分组：{{ item.group_name|default:"未分组" }}</div>
                            </div>
                            <span class="text-muted small">{{ item.created_at|date:"Y-m-d H:i" }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="text-muted small">暂无最近活动记录</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'totp/add_modal.html' %}
{% include 'totp/import_modal.html' %}
{% else %}
<div class="container py-5 text-center">
    <i class="bi bi-shield-lock display-4 text-primary mb-3"></i>
    <h1 class="display-5 mb-3">安全高效的 TOTP 管理中心</h1>
    <p class="lead text-muted mb-4">统一管理动态验证码，轻松完成双重验证(2FA)和团队协作。</p><br />
    <div class="d-flex flex-column flex-md-row justify-content-center align-items-center gap-3">
        <a href="{% url 'accounts:login' %}" class="btn btn-primary btn-lg px-4">立即登录</a>
        <a href="{% url 'accounts:signup' %}" class="btn btn-outline-primary btn-lg px-4">免费注册</a>
        <a href="{% url 'totp:external_totp_tool' %}" class="btn btn-outline-secondary btn-lg px-4">
            在线验证码工具
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if request.user.is_authenticated %}
<script>
    (function(){
      const total = {{ stats.current_cycle_total|default:30 }};
      let remain = {{ stats.current_cycle_remaining|default:0 }};
      const progress = document.getElementById('cycle-progress');
      const remainEl = document.getElementById('cycle-remaining');
      if (progress && remainEl && total > 0) {
        function update(){
          const percent = Math.round(((total - remain) / total) * 100);
          progress.style.width = percent + '%';
          progress.setAttribute('aria-valuenow', percent);
          remainEl.textContent = remain;
          remain = remain <= 1 ? total : remain - 1;
        }
        update();
        setInterval(update, 1000);
      }
    })();

    (function(){
      const importPreviewUrl = "{% url 'totp:batch_import_preview' %}";
      const importApplyUrl = "{% url 'totp:batch_import_apply' %}";
      const importModalEl = document.getElementById('importModal');
      if (!importModalEl) {
        return;
      }

      const importModeRadios = importModalEl.querySelectorAll('input[name="importMode"]');
      const importManualPanel = document.getElementById('importManualPanel');
      const importManualText = document.getElementById('importManualText');
      const importFilePanel = document.getElementById('importFilePanel');
      const importFileInput = document.getElementById('importFileInput');
      const importPreviewBtn = document.getElementById('importPreviewBtn');
      const importApplyBtn = document.getElementById('importApplyBtn');
      const importErrorAlert = document.getElementById('importErrorAlert');
      const importWarningAlert = document.getElementById('importWarningAlert');
      const importWarningList = document.getElementById('importWarningList');
      const importPreviewWrapper = document.getElementById('importPreviewWrapper');
      const importPreviewBody = document.getElementById('importPreviewBody');
      const importPreviewSummary = document.getElementById('importPreviewSummary');
      let importPreviewPayload = null;

      function getCsrfToken() {
        const match = document.cookie.match(/csrftoken=([^;]+)/);
        return match ? decodeURIComponent(match[1]) : '';
      }

      function setButtonLoading(button, loading, label) {
        if (!button) {
          return;
        }
        if (loading) {
          button.disabled = true;
          if (!button.dataset.originalLabel) {
            button.dataset.originalLabel = button.innerHTML;
          }
          const text = label || button.dataset.originalLabel || '';
          button.innerHTML = `<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>${text}`;
        } else {
          button.disabled = false;
          if (button.dataset.originalLabel) {
            button.innerHTML = button.dataset.originalLabel;
            delete button.dataset.originalLabel;
          }
        }
      }

      function currentImportMode() {
        const active = Array.from(importModeRadios).find((radio) => radio.checked);
        return active ? active.value : 'manual';
      }

      function hideImportFeedback() {
        importErrorAlert?.classList.add('d-none');
        if (importWarningAlert && importWarningList) {
          importWarningAlert.classList.add('d-none');
          importWarningList.replaceChildren();
        }
      }

      function showImportError(message) {
        if (!importErrorAlert) {
          return;
        }
        importErrorAlert.textContent = message;
        importErrorAlert.classList.toggle('d-none', !message);
      }

      function showImportWarnings(warnings) {
        if (!importWarningAlert || !importWarningList) {
          return;
        }
        importWarningList.replaceChildren();
        if (warnings && warnings.length) {
          warnings.forEach((text) => {
            const li = document.createElement('li');
            li.textContent = text;
            importWarningList.appendChild(li);
          });
          importWarningAlert.classList.remove('d-none');
        } else {
          importWarningAlert.classList.add('d-none');
        }
      }

      function setImportMode(mode) {
        if (mode === 'file') {
          importManualPanel?.classList.add('d-none');
          importFilePanel?.classList.remove('d-none');
        } else {
          importManualPanel?.classList.remove('d-none');
          importFilePanel?.classList.add('d-none');
        }
        hideImportFeedback();
        importPreviewPayload = null;
        importPreviewWrapper?.classList.add('d-none');
        if (importApplyBtn) {
          importApplyBtn.classList.add('d-none');
          importApplyBtn.disabled = true;
          delete importApplyBtn.dataset.originalLabel;
          importApplyBtn.innerHTML = '确认导入';
        }
        setButtonLoading(importPreviewBtn, false);
      }

      function resetImportModal() {
        importPreviewPayload = null;
        if (importManualText) {
          importManualText.value = '';
        }
        if (importFileInput) {
          importFileInput.value = '';
        }
        hideImportFeedback();
        importPreviewWrapper?.classList.add('d-none');
        importPreviewBody?.replaceChildren();
        if (importPreviewSummary) {
          importPreviewSummary.textContent = '预览结果如下，请确认后导入：';
        }
        if (importModeRadios.length) {
          importModeRadios.forEach((radio) => {
            radio.checked = radio.value === 'manual';
          });
        }
        setImportMode('manual');
      }

      function renderImportPreview(entries, summary) {
        if (!importPreviewWrapper || !importPreviewBody) {
          return;
        }
        importPreviewBody.replaceChildren();
        entries.forEach((entry) => {
          const tr = document.createElement('tr');

          const nameTd = document.createElement('td');
          nameTd.textContent = entry.name || '—';
          tr.appendChild(nameTd);

          const groupTd = document.createElement('td');
          groupTd.textContent = entry.group || '—';
          tr.appendChild(groupTd);

          const sourceTd = document.createElement('td');
          sourceTd.textContent = entry.source || '—';
          tr.appendChild(sourceTd);

          const statusTd = document.createElement('td');
          statusTd.classList.add('text-nowrap');
          const badge = document.createElement('span');
          badge.className = entry.exists ? 'badge text-bg-secondary' : 'badge text-bg-success';
          badge.textContent = entry.exists ? '已存在' : '新建';
          statusTd.appendChild(badge);
          tr.appendChild(statusTd);

          const secretTd = document.createElement('td');
          secretTd.classList.add('text-nowrap');
          const codeEl = document.createElement('code');
          codeEl.textContent = entry.secret_preview || '';
          secretTd.appendChild(codeEl);
          tr.appendChild(secretTd);

          importPreviewBody.appendChild(tr);
        });

        if (importPreviewSummary && summary) {
          importPreviewSummary.textContent = `共 ${summary.total} 条，预计新增 ${summary.new} 条，跳过 ${summary.existing} 条重复。`;
        }
        importPreviewWrapper.classList.remove('d-none');
      }

      if (importModeRadios.length) {
        importModeRadios.forEach((radio) => {
          radio.addEventListener('change', () => setImportMode(radio.value));
        });
        setImportMode(currentImportMode());
      }

      importPreviewBtn?.addEventListener('click', () => {
        hideImportFeedback();
        importPreviewWrapper?.classList.add('d-none');
        importPreviewPayload = null;
        const mode = currentImportMode();
        const formData = new FormData();
        formData.append('mode', mode);

        if (mode === 'file') {
          const file = importFileInput?.files?.[0];
          if (!file) {
            showImportError('请选择要导入的文件');
            return;
          }
          formData.append('file', file);
        } else {
          const value = importManualText?.value.trim() || '';
          if (!value) {
            showImportError('请粘贴待导入的内容');
            return;
          }
          formData.append('manual_text', value);
        }

        setButtonLoading(importPreviewBtn, true, '解析中...');

        fetch(importPreviewUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCsrfToken(),
          },
          body: formData,
          credentials: 'same-origin',
        })
          .then(async (resp) => {
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data.ok) {
              const message = (data.errors && data.errors[0]) || data.error || '解析失败，请检查格式';
              throw new Error(message);
            }
            importPreviewPayload = data.entries.map((entry) => ({
              name: entry.name,
              group: entry.group,
              secret: entry.secret,
              source: entry.source,
            }));
            renderImportPreview(data.entries, data.summary);
            showImportWarnings(data.warnings || []);
            if (importApplyBtn) {
              importApplyBtn.classList.remove('d-none');
              importApplyBtn.disabled = false;
            }
          })
          .catch((err) => {
            showImportError(err.message || '解析失败，请稍后再试');
          })
          .finally(() => {
            setButtonLoading(importPreviewBtn, false);
          });
      });

      importApplyBtn?.addEventListener('click', () => {
        if (!importPreviewPayload || !importPreviewPayload.length) {
          showImportError('请先完成预览');
          return;
        }
        setButtonLoading(importApplyBtn, true, '导入中...');
        fetch(importApplyUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
          },
          body: JSON.stringify({ entries: importPreviewPayload }),
          credentials: 'same-origin',
        })
          .then(async (resp) => {
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data.ok) {
              const message = data.error || '导入失败，请稍后再试';
              throw new Error(message);
            }
            if (data.redirect) {
              window.location.href = data.redirect;
            } else {
              window.location.reload();
            }
          })
          .catch((err) => {
            showImportError(err.message || '导入失败，请稍后再试');
            setButtonLoading(importApplyBtn, false);
          });
      });

      importModalEl.addEventListener('hidden.bs.modal', () => {
        resetImportModal();
      });
    })();
</script>
{% endif %}
{% endblock %}
