{% extends 'base.html' %}
{% load static %}
{% block title %}2FA在线工具,TOTP管理平台,动态验证码助手{% endblock %}
{% block head %}
{{ block.super }}
<meta name="keywords"
      content="2FA,2fa,2fa在线工具,2FA Auth,2FA live,2FA Code,双重验证工具,2FA在线工具"/>
<meta name="description"
      content="免费的TOTP管理平台,动态验证码助手OTP管理平台,2FA在线工具"/>
{% endblock %}
{% block content %}
{% if request.user.is_authenticated %}
<div class="py-3 py-md-4">

    <!-- 顶部欢迎区 -->
    <div class="card border-0 shadow-sm dashboard-hero mb-4">
        <div class="card-body d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3">
            <div>
                <h1 class="h3 fw-semibold mb-2">欢迎回来，{{ request.user.username }}</h1>
                <p class="mb-0 text-muted small">统一查看验证码、管理团队密钥，并通过审计时间线掌握一切重要操作。</p>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#addModal">
                    <i class="bi bi-plus-lg me-1"></i> 添加密钥
                </button>
                <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#importModal">
                    <i class="bi bi-arrow-bar-up me-1"></i> 批量导入
                </button>
                <a class="btn btn-outline-secondary" href="{% url 'totp:list' %}"><i class="bi bi-grid me-1"></i> 我的密钥</a>
            </div>
        </div>
    </div>

    <!-- 关键统计 -->
    <div class="row g-3 g-md-4 mb-4">
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card metric-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-start justify-content-between">
                        <div>
                            <div class="metric-label">全部密钥</div>
                            <div class="metric-value">{{ stats.total_entries|default:0 }}</div>
                        </div>
                        <div class="metric-icon metric-icon--primary">
                            <i class="bi bi-collection"></i>
                        </div>
                    </div>
                    <p class="text-muted small mb-0">含个人与团队空间全部条目{% if stats.today_added %} · 今日新增 {{ stats.today_added }}{% endif %}</p>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-xl-3">
            <div class="card metric-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-start justify-content-between">
                        <div>
                            <div class="metric-label">个人空间条目</div>
                            <div class="metric-value">{{ stats.personal_entries|default:0 }}</div>
                        </div>
                        <div class="metric-icon metric-icon--secondary">
                            <i class="bi bi-person-lines-fill"></i>
                        </div>
                    </div>
                    <p class="text-muted small mb-0">{% if stats.group_count %}使用 {{ stats.group_count }} 个分组{% else %}尚未设置分组{% endif %}</p>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-xl-3">
            <div class="card metric-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-start justify-content-between">
                        <div>
                            <div class="metric-label">团队空间条目</div>
                            <div class="metric-value">{{ stats.shared_entries|default:0 }}</div>
                        </div>
                        <div class="metric-icon metric-icon--info">
                            <i class="bi bi-people"></i>
                        </div>
                    </div>
                    <p class="text-muted small mb-0">{% if stats.team_count %}来自 {{ stats.team_count }} 个团队{% else %}尚未加入团队空间{% endif %}</p>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-xl-3">
            <div class="card metric-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-start justify-content-between">
                        <div>
                            <div class="metric-label">验证码刷新</div>
                            {% with remain=stats.current_cycle_remaining|default:0 total=stats.current_cycle_total|default:30 %}
                            {% if total > 0 %}
                            {% widthratio remain total 100 as pct %}
                            <div class="metric-value"><span id="cycle-remaining-main">{{ remain|default:0 }}</span>s</div>
                            {% else %}
                            <div class="metric-value">--</div>
                            {% endif %}
                            {% endwith %}
                        </div>
                        <div class="metric-icon metric-icon--warning">
                            <i class="bi bi-stopwatch"></i>
                        </div>
                    </div>
                    {% with remain=stats.current_cycle_remaining|default:0 total=stats.current_cycle_total|default:30 %}
                    {% if total > 0 %}
                    {% widthratio remain total 100 as pct %}
                    <div class="progress progress-thin" role="progressbar" aria-label="当前周期剩余" aria-valuemin="0" aria-valuemax="100">
                        <div id="cycle-progress" class="progress-bar bg-warning" style="width:{{ pct }}%" aria-valuenow="{{ pct }}"></div>
                    </div>
                    <p class="text-muted small mb-0 mt-1">周期 {{ total }}s · 剩余 <span id="cycle-remaining">{{ remain }}</span>s</p>
                    {% else %}
                    <p class="text-muted small mb-0">—</p>
                    {% endif %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>

    <!-- 快捷操作 & 使用说明 -->
    <div class="row g-3 g-md-4">
        <div class="col-12 col-lg-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h2 class="h6 mb-0"><i class="bi bi-lightning-charge me-1 text-primary"></i> 快速上手</h2>
                        <a href="{% url 'totp:list' %}" class="btn btn-sm btn-outline-secondary">我的密钥</a>
                    </div>
                    <ul class="list-unstyled mb-0 quick-start-list">
                        <li class="d-flex align-items-start gap-3 mb-3">
                            <span class="quick-start-step">1</span>
                            <div>
                                <strong>选择操作空间</strong>
                                <p class="mb-0 text-muted small">先通过顶部空间切换器定位到个人或团队空间，确保操作权限正确。</p>
                            </div>
                        </li>
                        <li class="d-flex align-items-start gap-3 mb-3">
                            <span class="quick-start-step">2</span>
                            <div>
                                <strong>写入或导入密钥</strong>
                                <p class="mb-0 text-muted small">使用“添加密钥”或“批量导入”，导入预览会提示重复项并可指定团队。</p>
                            </div>
                        </li>
                        <li class="d-flex align-items-start gap-3 mb-3">
                            <span class="quick-start-step">3</span>
                            <div>
                                <strong>日常管理与分享</strong>
                                <p class="mb-0 text-muted small">在列表页复制验证码、调整分组；生成一次性链接可安全分享给同事。</p>
                            </div>
                        </li>
                        <li class="d-flex align-items-start gap-3">
                            <span class="quick-start-step">4</span>
                            <div>
                                <strong>备份与合规</strong>
                                <p class="mb-0 text-muted small">导出或生成离线包后请妥善加密保存，回收站与审计时间线便于追踪与恢复。</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-5">
            <div class="d-flex flex-column gap-3 h-100">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-transparent border-0 d-flex align-items-center justify-content-between">
                        <h2 class="h6 mb-0">最近活动</h2>
                        <i class="bi bi-activity text-muted"></i>
                    </div>
                    <div class="card-body pt-0">
                        {% if recent_entries %}
                        <ul class="list-group list-group-flush border-top-0">
                            {% for item in recent_entries %}
                            <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                <div class="me-3">
                                    <div class="fw-semibold">{{ item.name }}</div>
                                    <div class="text-muted small">
                                        {% if item.team_name %}
                                        团队：{{ item.team_name }}
                                        {% else %}
                                        个人空间 · 分组：{{ item.group_name|default:"未分组" }}
                                        {% endif %}
                                    </div>
                                </div>
                                <span class="text-muted small">{{ item.created_at|date:"Y-m-d H:i" }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <div class="text-muted small">暂无最近活动记录</div>
                        {% endif %}
                    </div>
                </div>
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0 d-flex align-items-center justify-content-between">
                        <h2 class="h6 mb-0">密钥审计时间线</h2>
                        <i class="bi bi-journal-text text-muted"></i>
                    </div>
                    <div class="card-body pt-0">
                        {% if recent_audits %}
                        <ul class="timeline list-unstyled mb-0">
                            {% for audit in recent_audits %}
                            <li class="mb-3">
                                <div class="fw-semibold">{{ audit.entry.name }}</div>
                                <div class="text-muted small">
                                    {% if audit.action == 'created' %}创建{% elif audit.action == 'renamed' %}重命名{% elif audit.action == 'group_changed' %}分组调整{% elif audit.action == 'trashed' %}移入回收站{% elif audit.action == 'restored' %}恢复{% elif audit.action == 'deleted' %}永久删除{% else %}操作{% endif %}
                                    {% if audit.old_value or audit.new_value %}
                                    · {{ audit.old_value|default:'—' }} → {{ audit.new_value|default:'—' }}
                                    {% endif %}
                                    {% if audit.entry.team %}
                                    · 团队：{{ audit.entry.team.name }}
                                    {% else %}
                                    · 个人空间
                                    {% endif %}
                                </div>
                                <div class="text-muted small">
                                    {{ audit.created_at|date:"Y-m-d H:i" }}
                                    {% if audit.actor %}
                                    · 由 {{ audit.actor.username }}
                                    {% endif %}
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <div class="text-muted small">暂无新的审计记录。</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'totp/add_modal.html' %}
{% include 'totp/import_modal.html' %}
{% else %}
<div class="container py-5 text-center">
    <i class="bi bi-shield-lock display-4 text-primary mb-3"></i>
    <h1 class="display-5 mb-3">安全高效的 TOTP 管理中心</h1>
    <p class="lead text-muted mb-4">统一管理动态验证码，轻松完成双重验证(2FA)和团队协作。</p><br />
    <div class="d-flex flex-column flex-md-row justify-content-center align-items-center gap-3">
        <a href="{% url 'accounts:login' %}" class="btn btn-primary btn-lg px-4">立即登录</a>
        <a href="{% url 'accounts:signup' %}" class="btn btn-outline-primary btn-lg px-4">免费注册</a>
        <a href="{% url 'totp:external_totp_tool' %}" class="btn btn-outline-secondary btn-lg px-4">
            在线验证码工具
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if request.user.is_authenticated %}
<script src="{% static 'js/import_modal.js' %}"></script>
<script>
    (function () {
      const total = Number('{{ stats.current_cycle_total|default:30 }}');
      const initialRemain = Number('{{ stats.current_cycle_remaining|default:0 }}');
      const progress = document.getElementById('cycle-progress');
      const remainEl = document.getElementById('cycle-remaining');

      const safeTotal = Number.isFinite(total) ? Math.max(0, total) : 0;
      if (!progress || !remainEl || safeTotal <= 0) {
        return;
      }

      const safeRemain = Number.isFinite(initialRemain)
        ? Math.min(safeTotal, Math.max(0, initialRemain))
        : 0;
      const cycleMs = safeTotal * 1000;
      const elapsedMs = Math.min(cycleMs, Math.max(0, (safeTotal - safeRemain) * 1000));
      let cycleStart = Date.now() - elapsedMs;
      let timerId = null;

      function render() {
        const now = Date.now();
        if (now < cycleStart) {
          cycleStart = now;
        }

        const elapsedSinceStart = now - cycleStart;
        if (elapsedSinceStart >= cycleMs) {
          const cyclesPassed = Math.floor(elapsedSinceStart / cycleMs) || 1;
          cycleStart += cyclesPassed * cycleMs;
        }

        const remainingMs = Math.max(0, cycleStart + cycleMs - now);
        const secondsLeft = Math.max(0, Math.ceil(remainingMs / 1000));
        if (remainEl.textContent !== String(secondsLeft)) {
          remainEl.textContent = secondsLeft;
        }

        const percent = cycleMs
          ? Math.min(100, Math.max(0, Math.round(((cycleMs - remainingMs) / cycleMs) * 100)))
          : 0;
        if (progress.style.width !== `${percent}%`) {
          progress.style.width = `${percent}%`;
          progress.setAttribute('aria-valuenow', String(percent));
        }
      }

      function start() {
        if (!timerId) {
          render();
          timerId = setInterval(render, 1000);
        }
      }

      function stop() {
        if (timerId) {
          clearInterval(timerId);
          timerId = null;
        }
      }

      function handleVisibilityChange() {
        if (document.hidden) {
          stop();
        } else {
          render();
          start();
        }
      }

      start();

      document.addEventListener('visibilitychange', handleVisibilityChange);
      window.addEventListener('beforeunload', stop);
    })();

    TotpImportModal?.init({
      modalId: 'importModal',
      previewUrl: "{% url 'totp:batch_import_preview' %}",
      applyUrl: "{% url 'totp:batch_import_apply' %}",
      defaultSpace: 'personal',
    });
</script>
{% endif %}
{% endblock %}
